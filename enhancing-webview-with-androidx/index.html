<!doctype html><html lang=zh-cn><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://clientinfra.com/images/favicon.png><title>使用 AndroidX 增强 WebView 的能力 | Client Infra</title>
<meta name=title content="使用 AndroidX 增强 WebView 的能力"><meta name=description content="使用 AndroidX 增强 WebView 的能力"><meta name=keywords content="AndroidX,WebView,JavascriptEngine,Jetpack,"><meta property="og:title" content="使用 AndroidX 增强 WebView 的能力"><meta property="og:description" content="使用 AndroidX 增强 WebView 的能力"><meta property="og:type" content="article"><meta property="og:url" content="https://clientinfra.com/enhancing-webview-with-androidx/"><meta property="og:image" content="https://clientinfra.com/images/share.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2024-02-25T00:24:24+08:00"><meta property="article:modified_time" content="2024-02-25T00:24:24+08:00"><meta property="og:site_name" content="Client Infra"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://clientinfra.com/images/share.png"><meta name=twitter:title content="使用 AndroidX 增强 WebView 的能力"><meta name=twitter:description content="使用 AndroidX 增强 WebView 的能力"><meta itemprop=name content="使用 AndroidX 增强 WebView 的能力"><meta itemprop=description content="使用 AndroidX 增强 WebView 的能力"><meta itemprop=datePublished content="2024-02-25T00:24:24+08:00"><meta itemprop=dateModified content="2024-02-25T00:24:24+08:00"><meta itemprop=wordCount content="922"><meta itemprop=image content="https://clientinfra.com/images/share.png"><meta itemprop=keywords content="AndroidX,WebView,JavascriptEngine,Jetpack,"><meta name=referrer content="no-referrer-when-downgrade"><style>body{font-family:-apple-system,system-ui,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial!important;margin:auto;padding:20px;max-width:720px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6,strong,b{color:#222}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code,pre{font-family:Menlo,Monaco,courier new,monospace}code{padding:.25em .5em;font-size:85%;color:#bf616a;background-color:#f9f9f9;border-radius:3px}pre{display:block;margin-top:0;margin-bottom:1rem;padding:1rem;font-size:.8rem;line-height:1.4;white-space:pre;white-space:pre-wrap;word-break:break-all;word-wrap:break-word;background-color:#f9f9f9;overflow-x:auto;tab-size:4;-moz-tab-size:4;padding:0}pre code{padding:0;font-size:100%;color:inherit;background-color:transparent}.highlight{margin-bottom:1rem;border-radius:4px}.highlight pre{margin-bottom:0}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:#8b6fcb}.nav{display:flex;align-items:baseline;flex-wrap:wrap;justify-content:space-between;margin-bottom:1rem}.nav-title{font-family:lora,sans-serif;font-size:1.5rem;color:#000;letter-spacing:-.055rem;font-weight:400;white-space:nowrap;text-decoration:none}.nav-links a{font-family:fira code,monospace;text-transform:lowercase;color:#b3b3b3;margin-right:2rem;font-weight:300;text-align:right;text-decoration:none}.nav-links a:last-of-type{margin-right:0}@media(prefers-color-scheme:dark){body{background-color:#333;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#8cc2dd}code{background-color:#777}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}.helptext{color:#aaa}}</style><link href="https://fonts.googlefonts.cn/css?family=Lora:700" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Noto+Serif+SC:400,700&amp;display=swap&amp;subset=chinese-simplified" rel=stylesheet><link href=https://cdn.bootcdn.net/ajax/libs/highlight.js/11.8.0/styles/base16/dracula.min.css rel=stylesheet><script src=https://cdn.bootcdn.net/ajax/libs/highlight.js/11.8.0/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script></head><body><header><nav class=nav><a class=nav-title href=https://clientinfra.com/>Client Infra</a><div class=nav-links><a href=/blog>Posts</a></div></nav></header><main><h1>使用 AndroidX 增强 WebView 的能力</h1><p><i><time datetime=2024-02-25 pubdate>25 Feb, 2024</time></i></p><content><p>在应用开发过程中，为了在多个平台上保持一致的用户体验和提高开发效率，许多应用程序选择使用 H5 技术。在 Android 平台上，通常使用 WebView 组件来承载 H5 内容以供展示。</p><h2 id=webview-存在的问题>WebView 存在的问题</h2><p>自 Android Lollipop 起，WebView 组件的升级已经独立于 Android 平台。然而，控制 WebView 的 API(android.webkit) 仍然与平台升级相关。这意味着应用开发者只能使用当前平台所定义的接口，而无法充分利用 WebView 的全部能力。例如: <code>WebView.startSafeBrowsing</code> API 在 Android 8.1 上被添加，该 Feature 由 WebView 提供，即使我们在 Android 7.0 更新 WebView 拥有了该 Feature ,由于 Android 7.0 没有 <code>WebView.startSafeBrowsing</code> API ，我们也没办法使用该功能。</p><p>WebView 的实现基于 <strong>Chromium</strong> 开源项目,而 Android 则基于 <strong>AOSP</strong> 项目，这两个项目有着不同的发布周期，WebView 往往一个月就可以推出下一个版本，而 Android 则需要一年的时间，对于 WebView 新增的 Feature 我们最迟需要一年才能使用。</p><h2 id=androidx-webkit-的出现>AndroidX Webkit 的出现</h2><p>为了解决上面平台能力和 WebView 不匹配的问题，我们可以独立于平台之外定义一套 WebView API ，并让它随着 WebView 的 Feature 更新 API ，这样解决了现有的问题却导入了另一个问题——如何将新定义的 WebView API 和 WebView 进行衔接。</p><p>从应用开发的角度，系统 WebView 难以修改，自己编译定制一个 WebView 并随着 apk 提供是一个很好方案。这时候，我们可以轻松的解决衔接问题，并能够按照需求，任意增改 Feature 而不必等官方更新。同时解决了兼容问题和 WebView 内核碎片化的问题。腾讯 X5 ,UC U4 等都是这个方案。维护一份 WebView 并不是一件容易的事，需要投入更多的人力支持，因为将 WebView 打入包中，还伴随着包体积的急剧增加。</p><p>从 Android 官方的角度，可以推动 WebView 上游支持该 WebView API , 而这正是 AndroidX Webkit 的解决方案。Android 官方将定义的 WebView API 放置到 AndroidX Webkit 库，以支持频繁的更新，并在 WebView 上游增加“胶水层”与 AndroidX Webkit 进行衔接,这样在旧版的 Android 平台上，只要安装了拥有"胶水"层代码的 WebView ,也就拥有了新版平台的功能。</p><blockquote><p>“胶水层” 是在某个版本之后才后才支持的，旧版本的 WebView 内核并不支持，这也是为什么在调用之前始终应该检查 <code>isFeatureSupported</code> 的原因。</p></blockquote><h2 id=androidx--webkit-的功能>AndroidX Webkit 的功能</h2><p>初步了解了 AndroidX Webkit 的产生和实现原理，下面带领大家看一下它都提供了哪些新能力能够增强我们的 WebView 。</p><h3 id=向下兼容>向下兼容</h3><p>如上文分析，AndroidX Webkit 提供了向下的兼容，如下面代码所示，由 <code>WebViewCompat</code> 提供兼容的接口调用。</p><blockquote><p>需要注意的是在调用之前对 <code>WebViewFeature</code> 的检查，对于每个 Feature ,AndroidX Webkit 会取平台和 WebView 所提供 Feature 的并集 ,在调用某个 API 之前必须进行检查，如果平台和 WebView 均不支持该API则将抛出 <code>UnsupportedOperationException</code> 异常。</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// Old code:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Build</span><span class=p>.</span><span class=na>VERSION</span><span class=p>.</span><span class=na>SDK_INT</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>Build</span><span class=p>.</span><span class=na>VERSION_CODES</span><span class=p>.</span><span class=na>O_MR1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>WebView</span><span class=p>.</span><span class=na>startSafeBrowsing</span><span class=p>(</span><span class=n>appContext</span><span class=p>,</span><span class=w> </span><span class=n>callback</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// New code:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>WebViewFeature</span><span class=p>.</span><span class=na>isFeatureSupported</span><span class=p>(</span><span class=n>WebViewFeature</span><span class=p>.</span><span class=na>START_SAFE_BROWSING</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>WebViewCompat</span><span class=p>.</span><span class=na>startSafeBrowsing</span><span class=p>(</span><span class=n>appContext</span><span class=p>,</span><span class=w> </span><span class=n>callback</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>如果我们扒开 <code>WebViewCompat</code> 的外衣查看他的源码（如下所示），会发现如果在当前版本 Platform API 提供了接口，就会直接调用 Platform API 的接口，而对于低版本，则由 AndroidX Webkit 和 WebView 的"通道"提供服务。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// WebViewCompat#startSafeBrowsing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>startSafeBrowsing</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Context</span><span class=w> </span><span class=n>context</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>ValueCallback</span><span class=o>&lt;</span><span class=n>Boolean</span><span class=o>&gt;</span><span class=w> </span><span class=n>callback</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ApiFeature</span><span class=p>.</span><span class=na>O_MR1</span><span class=w> </span><span class=n>feature</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>WebViewFeatureInternal</span><span class=p>.</span><span class=na>START_SAFE_BROWSING</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>feature</span><span class=p>.</span><span class=na>isSupportedByFramework</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ApiHelperForOMR1</span><span class=p>.</span><span class=na>startSafeBrowsing</span><span class=p>(</span><span class=n>context</span><span class=p>,</span><span class=w> </span><span class=n>callback</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>feature</span><span class=p>.</span><span class=na>isSupportedByWebView</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>getFactory</span><span class=p>().</span><span class=na>getStatics</span><span class=p>().</span><span class=na>initSafeBrowsing</span><span class=p>(</span><span class=n>context</span><span class=p>,</span><span class=w> </span><span class=n>callback</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=n>WebViewFeatureInternal</span><span class=p>.</span><span class=na>getUnsupportedOperationException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>对比上面的代码，使用平台 API（old code）时仅可以支持 90% 的用户，而使用 AndroidX Webkit（new code） 则可以覆盖大约 <strong>99%</strong> 的用户。</p><p><img src=https://img.clientinfra.com/client-infra-img/2024/02/70f811f0c0faecaa74a67950168afe15.png alt></p><h3 id=代理功能支持>代理功能支持</h3><p>一直以来WebView 的代理设置异常繁琐，当遇到复杂的代理规则就无能为力了。在 AndroidX Webkit 中增加了 ProxyController API 用于为 WebView 设置代理。<code>ProxyConfig.Builder</code> 类提供了设置代理以及配置代理的绕过方式等方法，通过组合可以满足复杂的代理场景。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>WebViewFeature</span><span class=p>.</span><span class=na>isFeatureSupported</span><span class=p>(</span><span class=n>WebViewFeature</span><span class=p>.</span><span class=na>PROXY_OVERRIDE</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ProxyConfig</span><span class=w> </span><span class=n>proxyConfig</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ProxyConfig</span><span class=p>.</span><span class=na>Builder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>addProxyRule</span><span class=p>(</span><span class=s>&#34;localhost:7890&#34;</span><span class=p>)</span><span class=w> </span><span class=c1>//添加要用于所有 URL 的代理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>addProxyRule</span><span class=p>(</span><span class=s>&#34;localhost:1080&#34;</span><span class=p>)</span><span class=w> </span><span class=c1>//优先级低于第一个代理，仅在上一个失败时应用</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>addDirect</span><span class=p>()</span><span class=w>                    </span><span class=c1>//当前面的代理失败时，不使用代理直连</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>addBypassRule</span><span class=p>(</span><span class=s>&#34;www.baidu.com&#34;</span><span class=p>)</span><span class=w> </span><span class=c1>//该网址不使用代理，直连服务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>addBypassRule</span><span class=p>(</span><span class=s>&#34;*.cn&#34;</span><span class=p>)</span><span class=w>          </span><span class=c1>//以.cn结尾的网址不使用代理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Executor</span><span class=w> </span><span class=n>executor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Runnable</span><span class=w> </span><span class=n>listener</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ProxyController</span><span class=p>.</span><span class=na>getInstance</span><span class=p>().</span><span class=na>setProxyOverride</span><span class=p>(</span><span class=n>proxyConfig</span><span class=p>,</span><span class=w> </span><span class=n>executor</span><span class=p>,</span><span class=w> </span><span class=n>listener</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>｝</span><span class=w>
</span></span></span></code></pre></div><p>以上代码定义了一个复杂的代理场景,我们为 WebView 设置了两个代理服务器，<code>localhost:1080</code> 仅当 <code>localhost:7890</code> 失败的情况下启用，<code>addDirect</code> 声明了如果两个服务器都失败则直连服务器，<code>addBypassRule</code> 规定了 <code>www.baidu.com</code> 和以 <code>.so</code> 结尾的域名始终不应该使用代理。</p><h4 id=白名单代理>白名单代理</h4><p>如果仅有少量的 URL 需要配置代理，我们可以使用 <code>setReverseBypassEnabled(true)</code> 方法将<code>addBypassRule</code> 添加的 URL 转变为使用代理服务器，而其他的 URL 则直连服务。</p><h3 id=安全的-webview-和-native-通信支持>安全的 WebView 和 Native 通信支持</h3><p>建立 WebView 和 Native 的双向通信是使用 Hybrid 混合开发模式的基础，在之前 Android 已经提供了一些机制能够让完成基本的通信，但是已有的接口都存在一些安全和性能问题，在 AndroidX 中增加了一个功能强大的接口 <code>addWebMessageListener</code> 兼顾了安全和性能等问题。</p><p>代码示例中将 JavaSript 对象 <code>replyObject</code> 注入到匹配 <code>allowedOriginRules</code>的上下文中，这样只有在可信的网站中才能被使用此对象，也就防止了不明来源的网络攻击者对该对象的利用。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// App (in Java)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>WebMessageListener</span><span class=w> </span><span class=n>myListener</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>WebMessageListener</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onPostMessage</span><span class=p>(</span><span class=n>WebView</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>WebMessageCompat</span><span class=w> </span><span class=n>message</span><span class=p>,</span><span class=w> </span><span class=n>Uri</span><span class=w> </span><span class=n>sourceOrigin</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kt>boolean</span><span class=w> </span><span class=n>isMainFrame</span><span class=p>,</span><span class=w> </span><span class=n>JavaScriptReplyProxy</span><span class=w> </span><span class=n>replyProxy</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// do something about view, message, sourceOrigin and isMainFrame.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>replyProxy</span><span class=p>.</span><span class=na>postMessage</span><span class=p>(</span><span class=s>&#34;Got it!&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>HashSet</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>allowedOriginRules</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashSet</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>Arrays</span><span class=p>.</span><span class=na>asList</span><span class=p>(</span><span class=s>&#34;[https://example.com](https://example.com/)&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Add WebMessageListeners.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>WebViewCompat</span><span class=p>.</span><span class=na>addWebMessageListener</span><span class=p>(</span><span class=n>webView</span><span class=p>,</span><span class=w> </span><span class=s>&#34;replyObject&#34;</span><span class=p>,</span><span class=w> </span><span class=n>allowedOriginRules</span><span class=p>,</span><span class=n>myListener</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>调用上述方法之后，在 JavaScript 上下文中我们就可以访问 <code>myObject</code> ，调用 <code>postMessage</code> 就可以回调 Native 端的 <code>onPostMessage</code> 方法并自动切换到主线程执行，当 Native 端需要发送消息给 WebView 时，可以通过 <code>JavaScriptReplyProxy.postMessage</code> 发送到 WebView ，并将消息传递给 <code>onmessage</code> 闭包。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// Web page (in JavaScript)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>myObject</span><span class=p>.</span><span class=nx>onmessage</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// prints &#34;Got it!&#34; when we receive the app&#39;s response.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>myObject</span><span class=p>.</span><span class=nx>postMessage</span><span class=p>(</span><span class=s2>&#34;I&#39;m ready!&#34;</span><span class=p>);</span>
</span></span></code></pre></div><h4 id=文件传递>文件传递</h4><p>在以往的通讯机制中，如果我们想传递一个图片只能将其转换为 base64 等进行传输，如果曾经使用过 <code>shouldOverrideUrlLoading</code> 拦截 url 大概率会遇见传输瓶颈，AndroidX Webkit 中很贴心的提供了字节流传递机制。</p><p><strong>Native 传递文件给 WebView</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// App (in Java)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>WebMessageListener</span><span class=w> </span><span class=n>myListener</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>WebMessageListener</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onPostMessage</span><span class=p>(</span><span class=n>WebView</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>WebMessageCompat</span><span class=w> </span><span class=n>message</span><span class=p>,</span><span class=w> </span><span class=n>Uri</span><span class=w> </span><span class=n>sourceOrigin</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kt>boolean</span><span class=w> </span><span class=n>isMainFrame</span><span class=p>,</span><span class=w> </span><span class=n>JavaScriptReplyProxy</span><span class=w> </span><span class=n>replyProxy</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Communication is setup, send file data to web.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>WebViewFeature</span><span class=p>.</span><span class=na>isFeatureSupported</span><span class=p>(</span><span class=n>WebViewFeature</span><span class=p>.</span><span class=na>WEB_MESSAGE_ARRAY_BUFFER</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c1>// Suppose readFileData method is to read content from file.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>fileData</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>readFileData</span><span class=p>(</span><span class=s>&#34;myFile.dat&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>replyProxy</span><span class=p>.</span><span class=na>postMessage</span><span class=p>(</span><span class=n>fileData</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// Web page (in JavaScript)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>myObject</span><span class=p>.</span><span class=nx>onmessage</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>data</span> <span class=k>instanceof</span> <span class=nx>ArrayBuffer</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>data</span> <span class=o>=</span> <span class=nx>event</span><span class=p>.</span><span class=nx>data</span><span class=p>;</span>  <span class=c1>// Received file content from app.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>dataView</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>DataView</span><span class=p>(</span><span class=nx>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Consume file content by using JavaScript DataView to access ArrayBuffer.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>myObject</span><span class=p>.</span><span class=nx>postMessage</span><span class=p>(</span><span class=s2>&#34;Setup!&#34;</span><span class=p>);</span>
</span></span></code></pre></div><p><strong>WebView 传递文件给 Native</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// Web page (in JavaScript)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>response</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>fetch</span><span class=p>(</span><span class=s1>&#39;example.jpg&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>ok</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>imageData</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>response</span><span class=p>.</span><span class=nx>arrayBuffer</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>myObject</span><span class=p>.</span><span class=nx>postMessage</span><span class=p>(</span><span class=nx>imageData</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// App (in Java)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>WebMessageListener</span><span class=w> </span><span class=n>myListener</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>WebMessageListener</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onPostMessage</span><span class=p>(</span><span class=n>WebView</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>WebMessageCompat</span><span class=w> </span><span class=n>message</span><span class=p>,</span><span class=w> </span><span class=n>Uri</span><span class=w> </span><span class=n>sourceOrigin</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kt>boolean</span><span class=w> </span><span class=n>isMainFrame</span><span class=p>,</span><span class=w> </span><span class=n>JavaScriptReplyProxy</span><span class=w> </span><span class=n>replyProxy</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>message</span><span class=p>.</span><span class=na>getType</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>WebMessageCompat</span><span class=p>.</span><span class=na>TYPE_ARRAY_BUFFER</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>imageData</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>message</span><span class=p>.</span><span class=na>getArrayBuffer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c1>// do something like draw image on ImageView.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>};</span><span class=w>
</span></span></span></code></pre></div><h3 id=深色主题的支持>深色主题的支持</h3><p>Android 10 提供了深色主题的支持，但是在 WebView 中显示的网页却不会自动显示深色主题, 这就表现出严重的割裂感，开发者只能通过修改 <code>css</code> 来达到目的，但这往往费时费力还存在兼容性问题，Android 官方为了改善这一用户体验，为 WebView 提供了深色主题的适配。</p><p>一个网页如何表现是和<a href=https://www.w3.org/TR/mediaqueries-5/#descdef-media-prefers-color-scheme><code>prefers-color-scheme</code></a> and <a href=https://www.w3.org/TR/css-color-adjust-1/#propdef-color-scheme><code>color-scheme</code></a> 这两个 Web 标准互操作的。 Android官方提供了一张表阐述了他们之间的关系。</p><p><img src=https://img.clientinfra.com/client-infra-img/2024/02/20fa57044228e65056483905ca9258f9.png alt></p><p>上面这张图比较复杂，简单来说如果你想让 WebView 的内容和应用的主题相匹配，你应该始终定义深色主题并实现 <code>prefers-color-scheme</code> ,而对于未定义 <code>prefers-color-scheme</code> 的页面，系统按照不同的策略选择算法生成或者显示默认页面。</p><blockquote><p>以 Android 12 或更低版本为目标平台的应用 API 设计过于复杂，以 Android 13 或更高版本为目标平台的应用精简了 API ，具体变更请参考<a href=https://developer.android.com/develop/ui/views/layout/webapps/dark-theme#12>官方文档</a></p></blockquote><h3 id=javascript-and-webassembly-执行引擎支持>JavaScript and WebAssembly 执行引擎支持</h3><p>我们有时候我们会在程序中运行 JavaScript 而不显示任何 Web 内容，比如小程序的逻辑层，使用 WebView 本能够满足我们的要求但是浪费了过多的资源，我们都知道在 WebView 中真正负责执行 JavaScript 的引擎是 <code>V8 </code>，但是我们又无法直接使用，所以我们的安装包中出现了各种各样的引擎：<code>Hermes</code>、<code>JSC</code> 、<code>V8</code>等。</p><p>Android 发现了这”群雄割据“的局面，推出了<a href="https://developer.android.com/jetpack/androidx/releases/javascriptengine?hl=zh-cn">AndroidX JavascriptEngine</a>，JavascriptEngine 直接使用了 WebView 的 V8 实现，由于不用分配其他 WebView 资源所以资源分配更低，并可以开启多个独立运行的环境，还针对传递大量数据做了优化。</p><p>代码展示了执行 JavaScript 和 WebAssembly 代码的使用:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=n>JavaScriptSandbox</span><span class=p>.</span><span class=na>isSupported</span><span class=p>()){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//连接到引擎</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ListenableFuture</span><span class=o>&lt;</span><span class=n>JavaScriptSandbox</span><span class=o>&gt;</span><span class=w> </span><span class=n>jsSandboxFuture</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=n>JavaScriptSandbox</span><span class=p>.</span><span class=na>createConnectedInstanceAsync</span><span class=p>(</span><span class=n>context</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//创建上下文 上下文间有简单的数据隔离</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>JavaScriptIsolate</span><span class=w> </span><span class=n>jsIsolate</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>jsSandbox</span><span class=p>.</span><span class=na>createIsolate</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//执行函数 &amp;&amp; 获取结果</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>code</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;function sum(a, b) { let r = a + b; return r.toString(); }; sum(3, 4)&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ListenableFuture</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>resultFuture</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>jsIsolate</span><span class=p>.</span><span class=na>evaluateJavaScriptAsync</span><span class=p>(</span><span class=n>code</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>String</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>resultFuture</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>5</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>SECONDS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Futures</span><span class=p>.</span><span class=na>addCallback</span><span class=p>(</span><span class=n>resultFuture</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=k>new</span><span class=w> </span><span class=n>FutureCallback</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onSuccess</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>result</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=n>text</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>result</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onFailure</span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>t</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=n>text</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>t</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>mainThreadExecutor</span><span class=p>);</span><span class=w> </span><span class=c1>//Wasm运行</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>final</span><span class=w> </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>hello_world_wasm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>0x00</span><span class=w> </span><span class=p>,</span><span class=n>0x61</span><span class=w> </span><span class=p>,</span><span class=n>0x73</span><span class=w> </span><span class=p>,</span><span class=n>0x6d</span><span class=w> </span><span class=p>,</span><span class=n>0x01</span><span class=w> </span><span class=p>,</span><span class=n>0x00</span><span class=w> </span><span class=p>,</span><span class=n>0x00</span><span class=w> </span><span class=p>,</span><span class=n>0x00</span><span class=w> </span><span class=p>,</span><span class=n>0x01</span><span class=w> </span><span class=p>,</span><span class=n>0x0a</span><span class=w> </span><span class=p>,</span><span class=n>0x02</span><span class=w> </span><span class=p>,</span><span class=n>0x60</span><span class=w> </span><span class=p>,</span><span class=n>0x02</span><span class=w> </span><span class=p>,</span><span class=n>0x7f</span><span class=w> </span><span class=p>,</span><span class=n>0x7f</span><span class=w> </span><span class=p>,</span><span class=n>0x01</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>0x7f</span><span class=w> </span><span class=p>,</span><span class=n>0x60</span><span class=w> </span><span class=p>,</span><span class=n>0x00</span><span class=w> </span><span class=p>,</span><span class=n>0x00</span><span class=w> </span><span class=p>,</span><span class=n>0x03</span><span class=w> </span><span class=p>,</span><span class=n>0x03</span><span class=w> </span><span class=p>,</span><span class=n>0x02</span><span class=w> </span><span class=p>,</span><span class=n>0x00</span><span class=w> </span><span class=p>,</span><span class=n>0x01</span><span class=w> </span><span class=p>,</span><span class=n>0x04</span><span class=w> </span><span class=p>,</span><span class=n>0x04</span><span class=w> </span><span class=p>,</span><span class=n>0x01</span><span class=w> </span><span class=p>,</span><span class=n>0x70</span><span class=w> </span><span class=p>,</span><span class=n>0x00</span><span class=w> </span><span class=p>,</span><span class=n>0x01</span><span class=w> </span><span class=p>,</span><span class=n>0x05</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>0x03</span><span class=w> </span><span class=p>,</span><span class=n>0x01</span><span class=w> </span><span class=p>,</span><span class=n>0x00</span><span class=w> </span><span class=p>,</span><span class=n>0x00</span><span class=w> </span><span class=p>,</span><span class=n>0x06</span><span class=w> </span><span class=p>,</span><span class=n>0x06</span><span class=w> </span><span class=p>,</span><span class=n>0x01</span><span class=w> </span><span class=p>,</span><span class=n>0x7f</span><span class=w> </span><span class=p>,</span><span class=n>0x00</span><span class=w> </span><span class=p>,</span><span class=n>0x41</span><span class=w> </span><span class=p>,</span><span class=n>0x08</span><span class=w> </span><span class=p>,</span><span class=n>0x0b</span><span class=w> </span><span class=p>,</span><span class=n>0x07</span><span class=w> </span><span class=p>,</span><span class=n>0x18</span><span class=w> </span><span class=p>,</span><span class=n>0x03</span><span class=w> </span><span class=p>,</span><span class=n>0x06</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>0x6d</span><span class=w> </span><span class=p>,</span><span class=n>0x65</span><span class=w> </span><span class=p>,</span><span class=n>0x6d</span><span class=w> </span><span class=p>,</span><span class=n>0x6f</span><span class=w> </span><span class=p>,</span><span class=n>0x72</span><span class=w> </span><span class=p>,</span><span class=n>0x79</span><span class=w> </span><span class=p>,</span><span class=n>0x02</span><span class=w> </span><span class=p>,</span><span class=n>0x00</span><span class=w> </span><span class=p>,</span><span class=n>0x05</span><span class=w> </span><span class=p>,</span><span class=n>0x74</span><span class=w> </span><span class=p>,</span><span class=n>0x61</span><span class=w> </span><span class=p>,</span><span class=n>0x62</span><span class=w> </span><span class=p>,</span><span class=n>0x6c</span><span class=w> </span><span class=p>,</span><span class=n>0x65</span><span class=w> </span><span class=p>,</span><span class=n>0x01</span><span class=w> </span><span class=p>,</span><span class=n>0x00</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>0x03</span><span class=w> </span><span class=p>,</span><span class=n>0x61</span><span class=w> </span><span class=p>,</span><span class=n>0x64</span><span class=w> </span><span class=p>,</span><span class=n>0x64</span><span class=w> </span><span class=p>,</span><span class=n>0x00</span><span class=w> </span><span class=p>,</span><span class=n>0x00</span><span class=w> </span><span class=p>,</span><span class=n>0x09</span><span class=w> </span><span class=p>,</span><span class=n>0x07</span><span class=w> </span><span class=p>,</span><span class=n>0x01</span><span class=w> </span><span class=p>,</span><span class=n>0x00</span><span class=w> </span><span class=p>,</span><span class=n>0x41</span><span class=w> </span><span class=p>,</span><span class=n>0x00</span><span class=w> </span><span class=p>,</span><span class=n>0x0b</span><span class=w> </span><span class=p>,</span><span class=n>0x01</span><span class=w> </span><span class=p>,</span><span class=n>0x01</span><span class=w> </span><span class=p>,</span><span class=n>0x0a</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>0x0c</span><span class=w> </span><span class=p>,</span><span class=n>0x02</span><span class=w> </span><span class=p>,</span><span class=n>0x07</span><span class=w> </span><span class=p>,</span><span class=n>0x00</span><span class=w> </span><span class=p>,</span><span class=n>0x20</span><span class=w> </span><span class=p>,</span><span class=n>0x00</span><span class=w> </span><span class=p>,</span><span class=n>0x20</span><span class=w> </span><span class=p>,</span><span class=n>0x01</span><span class=w> </span><span class=p>,</span><span class=n>0x6a</span><span class=w> </span><span class=p>,</span><span class=n>0x0b</span><span class=w> </span><span class=p>,</span><span class=n>0x02</span><span class=w> </span><span class=p>,</span><span class=n>0x00</span><span class=w> </span><span class=p>,</span><span class=n>0x0b</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>jsCode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;android.consumeNamedDataAsArrayBuffer(&#39;wasm-1&#39;).then(&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=s>&#34;(value) =&gt; { return WebAssembly.compile(value).then(&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=s>&#34;(module) =&gt; { return new WebAssembly.Instance(module).exports.add(20, 22).toString(); }&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=s>&#34;)})&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>boolean</span><span class=w> </span><span class=n>success</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>js</span><span class=p>.</span><span class=na>provideNamedData</span><span class=p>(</span><span class=s>&#34;wasm-1&#34;</span><span class=p>,</span><span class=w> </span><span class=n>hello_world_wasm</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>success</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>FluentFuture</span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>js</span><span class=p>.</span><span class=na>evaluateJavaScriptAsync</span><span class=p>(</span><span class=n>jsCode</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=p>.</span><span class=na>transform</span><span class=p>(</span><span class=k>this</span><span class=p>::</span><span class=n>println</span><span class=p>,</span><span class=w> </span><span class=n>mainThreadExecutor</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=p>.</span><span class=na>catching</span><span class=p>(</span><span class=n>Throwable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>println</span><span class=p>(</span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>()),</span><span class=w> </span><span class=n>mainThreadExecutor</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=c1>// the data chunk name has been used before, use a different name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=更多支持>更多支持</h3><p>AndroidX Webkit 是一个功能强大的库，由于篇幅原因上文将开发者比较常用的功能进行了列举，AndroidX 还提供对 WebView 更精细化的控制,对 Cookie 的便捷访问、对 Web 资源的便捷访问，对 WebView 性能的收集，还有对大屏幕的支持等等强大的 API,大家可以查看<a href="https://developer.android.com/jetpack/androidx/releases/webkit?hl=zh-cn#declaring_dependencies">发布页面</a>查看最新的功能。</p><h2 id=写在最后>写在最后</h2><p>本文从实际矛盾出发，带领大家思考 AndroidX Webkit 的产生原因和实现原理，对于AndroidX Webkit 的几个功能分别做了简单的介绍，希望大家能在这篇文章获得一点启发和帮助。</p></content><p><a href=https://clientinfra.com/blog/androidx/>#AndroidX</a>
<a href=https://clientinfra.com/blog/webview/>#WebView</a>
<a href=https://clientinfra.com/blog/javascriptengine/>#JavascriptEngine</a>
<a href=https://clientinfra.com/blog/jetpack/>#Jetpack</a></p><script src=https://giscus.app/client.js data-repo=nodmp/nodmp.github.io data-repo-id=R_kgDOLXPtcw data-category=Announcements data-category-id=DIC_kwDOLXPtc84CdeWg data-mapping=pathname data-strict=1 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN crossorigin=anonymous async></script></main><footer>Made with <a href=https://github.com/janraasch/hugo-bearblog/>ʕ•ᴥ•ʔ</a></footer></body></html>