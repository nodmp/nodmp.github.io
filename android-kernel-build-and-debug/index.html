<!doctype html><html lang=zh-cn><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://clientinfra.com/images/favicon.png><title>Android Kernel 编译与调试指北 | Client Infra</title>
<meta name=title content="Android Kernel 编译与调试指北"><meta name=description content="如何借助 Cuttlefish 虚拟机，进行 Android Kernel 的调试工作"><meta name=keywords content="AOSP,WSL2,Cuttlefish,Kernel,"><meta property="og:title" content="Android Kernel 编译与调试指北"><meta property="og:description" content="如何借助 Cuttlefish 虚拟机，进行 Android Kernel 的调试工作"><meta property="og:type" content="article"><meta property="og:url" content="https://clientinfra.com/android-kernel-build-and-debug/"><meta property="og:image" content="https://clientinfra.com/images/share.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2023-06-14T00:00:00+08:00"><meta property="article:modified_time" content="2023-06-14T00:00:00+08:00"><meta property="og:site_name" content="Client Infra"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://clientinfra.com/images/share.png"><meta name=twitter:title content="Android Kernel 编译与调试指北"><meta name=twitter:description content="如何借助 Cuttlefish 虚拟机，进行 Android Kernel 的调试工作"><meta itemprop=name content="Android Kernel 编译与调试指北"><meta itemprop=description content="如何借助 Cuttlefish 虚拟机，进行 Android Kernel 的调试工作"><meta itemprop=datePublished content="2023-06-14T00:00:00+08:00"><meta itemprop=dateModified content="2023-06-14T00:00:00+08:00"><meta itemprop=wordCount content="185"><meta itemprop=image content="https://clientinfra.com/images/share.png"><meta itemprop=keywords content="AOSP,WSL2,Cuttlefish,Kernel,"><meta name=referrer content="no-referrer-when-downgrade"><style>body{font-family:roboto slab,pingfang sc,source han sans sc,source han sans cn,noto sans cjk sc,wenquanyi micro hei,microsoft yahei,sans-serif;margin:auto;padding:20px;max-width:720px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6{font-weight:600}h1,h2,h3,h4,h5,h6,strong,b{color:#222}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code,pre{font-family:fira mono,courier new,pingfang sc,source han sans sc,source han sans cn,noto sans cjk sc,wenquanyi micro hei,microsoft yahei,monospace!important}code{padding:.25em .5em;font-size:85%;color:#bf616a;background-color:#f9f9f9;border-radius:3px}pre{display:block;margin-top:0;margin-bottom:1rem;padding:1rem;font-size:.8rem;line-height:1.4;white-space:pre;white-space:pre-wrap;word-break:break-all;word-wrap:break-word;background-color:#f9f9f9;overflow-x:auto;tab-size:4;-moz-tab-size:4;padding:0}pre code{padding:0;font-size:100%;color:inherit;background-color:transparent}.highlight{margin-bottom:1rem;border-radius:4px}.highlight pre{margin-bottom:0}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:#8b6fcb}.nav{display:flex;align-items:baseline;flex-wrap:wrap;justify-content:space-between;margin-bottom:1rem}.nav-title{font-family:lora,sans-serif;font-size:1.5rem;color:#000;letter-spacing:-.055rem;font-weight:400;white-space:nowrap;text-decoration:none}.nav-links a{font-family:fira code,monospace;text-transform:lowercase;color:#b3b3b3;margin-right:2rem;font-weight:300;text-align:right;text-decoration:none}.nav-links a:last-of-type{margin-right:0}#TableOfContents{font-size:90%;margin-left:0!important;padding:.7em 1em;border-left:.25em solid rgba(9 9 9/.6);background-color:rgba(23 22 25/5%);margin:1em 0}#TableOfContents li{text-align:justify}#TableOfContents ul{list-style:none;line-height:1.6;padding-left:1em;margin:0}#TableOfContents ul ul{margin-block-start:0;margin-block-end:0}@media(prefers-color-scheme:dark){body{background-color:#333;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#8cc2dd}code{background-color:#777;color:#fff}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}.helptext{color:#aaa}.nav-title{color:#ddd}pre{background-color:#333}#TableOfContents{background-color:rgba(0 0 0/.4)}}</style><link rel=stylesheet href="https://fonts.googlefonts.cn/css?family=Fira+Mono|Roboto+Slab:400,600|Noto+Serif+SC:600|Lora:700&display=swap"><script async src=https://umami.clientinfra.com/fd5c29bd-10f7-4017-80c8-9d7aaf7c3e8b data-website-id=b25f85f7-169d-4949-9ce5-1d9cea51b28c></script><link href=https://cdn.bootcdn.net/ajax/libs/highlight.js/11.8.0/styles/base16/dracula.min.css rel=stylesheet><script src=https://cdn.bootcdn.net/ajax/libs/highlight.js/11.8.0/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script></head><body><header><nav class=nav><a class=nav-title href=https://clientinfra.com/>Client Infra</a><div class=nav-links><a href=/blog>Posts</a></div></nav></header><main><h1>Android Kernel 编译与调试指北</h1><p><i><time datetime=2023-06-14 pubdate>14 Jun, 2023</time></i></p><aside><nav id=TableOfContents><ul><li><a href=#环境>环境</a></li><li><a href=#android-kernel-repo的源码下载>Android Kernel Repo的源码下载</a><ul><li><a href=#查找linux-kernel的version和commitid>查找Linux Kernel的version和commitId</a><ul><li><a href=#从android设置界面查找>从Android设置界面查找</a></li><li><a href=#从aosp树中查找>从AOSP树中查找</a></li></ul></li><li><a href=#根据分支拉取kernel代码>根据分支拉取Kernel代码</a><ul><li><a href=#根据kernelcommon的commitid找到对应repo分支>根据kernel/common的commitId找到对应repo分支</a></li><li><a href=#拉取kernel代码>拉取Kernel代码</a></li></ul></li></ul></li><li><a href=#bazel编译kernel>Bazel编译Kernel</a></li><li><a href=#cuttlefish-应用新内核>Cuttlefish 应用新内核</a></li><li><a href=#使用gdb调试kernel>使用GDB调试Kernel</a></li><li><a href=#总结>总结</a></li></ul></nav></aside><content><blockquote><p>上一篇文章介绍了在wsl2环境下编译AOSP并将其运行到Cuttlefish中，本篇文章依赖于上文Cuttlefish，请按照顺序食用本指北</p></blockquote><h2 id=环境>环境</h2><p>本指北基于以下代码和环境编写</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>OS     :  Ubuntu 22.04.2 LTS
</span></span><span class=line><span class=cl>AOSP   :  master
</span></span><span class=line><span class=cl>kernel :  根据编译目标决定
</span></span><span class=line><span class=cl>target ： aosp_cf_x86_64_phone-userdebug
</span></span><span class=line><span class=cl>设备    ： Cuttlefish
</span></span></code></pre></div><p>在前一篇文章说过，因为工具链的原因，AOSP的代码不宜太旧，自上一篇文章以来Cuttlefish的功能和文档逐步健全，足以见得google对其的投入程度，所以如果版本不一样会遇见无此参数等这样那样的问题，本文在master上测试通过。</p><h2 id=android-kernel-repo的源码下载>Android Kernel Repo的源码下载</h2><p>Linux Kernel是Android系统运行的基础，而Linux Kernel的源码在AOSP中并不存在，通常存在的是预构建的内核映像，如果想对内核做一些定制化的修改，就需要下载代码并构建，Linux Kernel像AOSP有各种各样的分支，并不是随便选择一个分支构建就可以正常运行。编译AOSP对应的Linux Kernel版本才能避免构建过程走很多弯路。每一个AOSP构建目标都预置了预编译的内核映像，可以从内核影像中获取相应版本的蛛丝马迹。</p><p>需要说明的是Android的内核项目同样是由repo(<a href=https://android.googlesource.com/kernel/manifest/>https://android.googlesource.com/kernel/manifest/</a>) 管理的，其中Linux Kernel的源码存在于kernel/common(<a href=https://android.googlesource.com/kernel/common/>https://android.googlesource.com/kernel/common/</a>) 目录下，其他目录是与构建相关的工具链或者脚本等，在之前旧版本Linux Kernel构建中可以直接下载kernel/common的代码使用make直接编译出内核镜像，但是随着Android GKI的推出，这套方法就行不通了。读者最好使用repo提供的编译脚本等进行构建。</p><blockquote><p>下面以<code>aosp_cf_x86_64_phone-userdebug</code>target为例，讲述如何一步步找到对应的分支</p></blockquote><h3 id=查找linux-kernel的version和commitid>查找Linux Kernel的version和commitId</h3><h4 id=从android设置界面查找>从Android设置界面查找</h4><p>如果你编译的系统已经成功运行到虚拟机，你可以打开Settings - About Phone - Android Version -Kernel Version 可以看到对应的Kernel信息，Linux的版本号按照major.minor.patch-build.desc的格式，通过匹配屏幕输出可以得出内核版本为6.1，从附加描述中提取g开头的连续字符可以得知对应的commitId为<code>963667856ef1</code></p><p><img src=https://img.clientinfra.com/client-infra-img/2024/02/048aa2224c63f50fc6563451f5a74662.png alt></p><h4 id=从aosp树中查找>从AOSP树中查找</h4><p>如果只有一个构建目标（aosp_cf_x86_64_phone-userdebug）并没有运行成功虚拟机，可以遵循以下步骤获取。</p><ol><li>索引到device/google/cuttlefish目录，device目录下存放了芯片和硬件厂商的相关产品配置,其中cuttlefish作为一款虚拟器，也被添加到了该目录下。</li><li>通过<code>mgrep ":kernel"</code>查看配置文件（该方法不是很通用，可以通过“<a href="https://source.android.com/docs/setup/create/new-device?hl=zh-cn">添加新设备</a>”了解相关知识），最后查看搜索到的配置文件,通过下图可以看到该目标链接的kernel映像文件位于<code>kernel/prebuilts/6.1/x86_64/kernel-6.1</code></li><li>对该文件执行<code>file kernel-6.1</code>得到以下输出，同样可以得到commmitId为<code>963667856ef1</code></li></ol><pre tabindex=0><code>kernel-6.1: Linux kernel x86 boot executable bzImage, version 6.1.25-android14-7-00377-g963667856ef1-ab10271074 (build-user@build-host) #1 SMP PREEMPT Tue Jun  6 23:03:20 UTC 2023, RO-rootFS, swap_dev 0X10, Normal VGA
</code></pre><p><img src=https://img.clientinfra.com/client-infra-img/2024/02/43a608e484ca28871be3fb4e651ee491.png alt></p><h3 id=根据分支拉取kernel代码>根据分支拉取Kernel代码</h3><p>通过上面的操作得到了Linux Kernel的版本和commitId，准备就绪就可以着手拉取代码了，需要注意上文获取的commitId是指https://android.googlesource.com/kernel/common/ 仓库的相应提交。</p><h4 id=根据kernelcommon的commitid找到对应repo分支>根据kernel/common的commitId找到对应repo分支</h4><p>直接访问https://android.googlesource.com/kernel/common/+/963667856ef1 （注意按照实际输出更改commitId） 就可以得到对应的changeId，通过点击changeId链接就可以看到对应gerrit 地址，如下所示，该页面同时标注了Linux kernel的分支[android14-6.1], 这里的branch还是Linux Kernel的分支，那么如何得到repo的分支内，只有<strong>猜</strong>了，通过在
<a href=https://android.googlesource.com/kernel/manifest/+refs>https://android.googlesource.com/kernel/manifest/+refs</a> 中搜索6.1找到了多个结果，通过依次查看该分支下的default.xml文件，发现common-android14-6.1分支下指向了Linux Kernel的android14-6.1分支，代码如下<a href=https://android.googlesource.com/kernel/manifest/+/refs/heads/common-android14-6.1/default.xml#14><code>&lt;project path="common" name="kernel/common" revision="android14-6.1" /></code></a></p><p><img src=https://img.clientinfra.com/client-infra-img/2024/02/d8eaaa4df8950e7563df616418d74815.png alt></p><p><img src=https://img.clientinfra.com/client-infra-img/2024/02/485e3319d3426973d0f3b82dbc240002.png alt></p><h4 id=拉取kernel代码>拉取Kernel代码</h4><p>使用从上文得到的kernel的repo分支，使用repo下载Linux Kernel的源码和脚本等</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>mkdir android-kernel <span class=o>&amp;&amp;</span> <span class=nb>cd</span> android-kernel
</span></span><span class=line><span class=cl>repo init -u https://android.googlesource.com/kernel/manifest -b common-android14-6.1
</span></span><span class=line><span class=cl>repo sync
</span></span></code></pre></div><p>如果一切OK，代码就下载好了，如果你遇见了任何网络问题，可以参照上一篇文章设置镜像源下载。</p><h2 id=bazel编译kernel>Bazel编译Kernel</h2><p>Android11引入了GKI的特性，用于将内核拆分为由 Google 维护的内核映像和由供应商维护的模块，两个模块分别构建。Android13开始使用Bazel进行编译，由于构建的分支是master分支，所以内核的编译需要使用bazel进行构建，并且需要分别构建两个内核。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>//通用内核镜像的构建
</span></span><span class=line><span class=cl>$ tools/bazel run //common:kernel_x86_64_dist -- --dist_dir<span class=o>=</span>out
</span></span><span class=line><span class=cl>//因为是虚拟机，所以是虚拟的设备GKI virtual_device
</span></span><span class=line><span class=cl>$ tools/bazel run //common-modules/virtual-device:virtual_device_x86_64_dist -- --dist_dir<span class=o>=</span>out
</span></span></code></pre></div><p>以上如果构建没有问题，在out目录下会生成<code>bzImage</code>和<code>initramfs.img</code>文件，请记住他们的位置，之后会用到</p><h2 id=cuttlefish-应用新内核>Cuttlefish 应用新内核</h2><p>使用kernel_path和initramfs_path即可对Cuttlefish应用新内核，十分方便，需要<strong>注意launch_cvd的运行基于上一篇文章编译成功，在AOSP根目录下运行</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>source</span> build/envsetup.sh
</span></span><span class=line><span class=cl>lunch aosp_cf_x86_64_phone-userdebug
</span></span><span class=line><span class=cl>launch_cvd -kernel_path /home/prosixe/ssd/Android/android-kernel/out/bzImage -initramfs_path /home/prosixe/ssd/Android/android-kernel/out/initramfs.img 
</span></span></code></pre></div><p><img src=https://img.clientinfra.com/client-infra-img/2024/02/97ad2cbe9d14c603d0079064891cc230.png alt>
通过查看系统信息，内核已经发生了改变，系统可以正常开机</p><h2 id=使用gdb调试kernel>使用GDB调试Kernel</h2><p>使用下面命令使内核可调试，读者实操时注意要区分aosp和android-kernel的目录。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>//注意在aosp根目录
</span></span><span class=line><span class=cl><span class=nb>source</span> build/envsetup.sh
</span></span><span class=line><span class=cl>lunch aosp_cf_x86_64_phone-userdebug
</span></span><span class=line><span class=cl>launch_cvd -kernel_path /home/prosixe/ssd/Android/android-kernel/out/bzImage -initramfs_path /home/prosixe/ssd/Android/android-kernel/out/initramfs.img -gdb_port <span class=m>1234</span> -cpus<span class=o>=</span><span class=m>1</span>  -extra_kernel_cmdline nokaslr
</span></span></code></pre></div><p>然后在另一个终端索引到android-kernel/common方便gdb索引到符号</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>//切换android-kernel根目录
</span></span><span class=line><span class=cl><span class=nb>cd</span> common
</span></span><span class=line><span class=cl>gdb ../out/vmlinux
</span></span><span class=line><span class=cl><span class=o>(</span>gdb<span class=o>)</span> target remote :1234
</span></span><span class=line><span class=cl><span class=o>(</span>gdb<span class=o>)</span> hbreak start_kernel
</span></span><span class=line><span class=cl><span class=o>(</span>gdb<span class=o>)</span> c
</span></span></code></pre></div><p><img src=https://img.clientinfra.com/client-infra-img/2024/02/cab6c3e73993d1709e43bb24d5c0c0bc.png alt>
可以看到内核在start_kernel时停止了，并且可以正常显示对应的源代码。</p><h2 id=总结>总结</h2><p>经过一步步的摸索，将Linux内核成功运行到了Cuttlefish中，在Cuttlefish的环境下，可以调试内核，调试Native代码，调试Framework代码，也可以当作你的常用“开发机”使用。<br>该文章是笔者学习中的一个总结，由于知识面的狭隘总有认识不到的错误产生，请大家不吝赐教。如果大家学习中遇见问题，也欢迎大家交流沟通。</p></content><p><a href=https://clientinfra.com/blog/aosp/>#AOSP</a>
<a href=https://clientinfra.com/blog/wsl2/>#WSL2</a>
<a href=https://clientinfra.com/blog/cuttlefish/>#Cuttlefish</a>
<a href=https://clientinfra.com/blog/kernel/>#Kernel</a></p><script src=https://giscus.app/client.js data-repo=nodmp/nodmp.github.io data-repo-id=R_kgDOLXPtcw data-category=Announcements data-category-id=DIC_kwDOLXPtc84CdeWg data-mapping=pathname data-strict=1 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN crossorigin=anonymous async></script></main><footer>Made with <a href=https://github.com/janraasch/hugo-bearblog/>ʕ•ᴥ•ʔ</a></footer></body></html>