<!doctype html><html lang=zh-cn><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://clientinfra.com/images/favicon.png><title>使用 Gradle 解决 Android 模块化项目中的多语言支持 | Client Infra</title>
<meta name=title content="使用 Gradle 解决 Android 模块化项目中的多语言支持"><meta name=description content="使用 Gradle 解决 Android 模块化项目中的多语言支持,为应用出海提供强大助力"><meta name=keywords content="Gradle,Android,"><meta property="og:title" content="使用 Gradle 解决 Android 模块化项目中的多语言支持"><meta property="og:description" content="使用 Gradle 解决 Android 模块化项目中的多语言支持,为应用出海提供强大助力"><meta property="og:type" content="article"><meta property="og:url" content="https://clientinfra.com/gradle-support-android-i18n/"><meta property="og:image" content="https://clientinfra.com/images/share.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2023-06-29T00:00:00+08:00"><meta property="article:modified_time" content="2023-06-29T00:00:00+08:00"><meta property="og:site_name" content="Client Infra"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://clientinfra.com/images/share.png"><meta name=twitter:title content="使用 Gradle 解决 Android 模块化项目中的多语言支持"><meta name=twitter:description content="使用 Gradle 解决 Android 模块化项目中的多语言支持,为应用出海提供强大助力"><meta itemprop=name content="使用 Gradle 解决 Android 模块化项目中的多语言支持"><meta itemprop=description content="使用 Gradle 解决 Android 模块化项目中的多语言支持,为应用出海提供强大助力"><meta itemprop=datePublished content="2023-06-29T00:00:00+08:00"><meta itemprop=dateModified content="2023-06-29T00:00:00+08:00"><meta itemprop=wordCount content="759"><meta itemprop=image content="https://clientinfra.com/images/share.png"><meta itemprop=keywords content="Gradle,Android,"><meta name=referrer content="no-referrer-when-downgrade"><style>body{font-family:roboto slab,pingfang sc,source han sans sc,source han sans cn,noto sans cjk sc,wenquanyi micro hei,microsoft yahei,sans-serif;margin:auto;padding:20px;max-width:720px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6{font-weight:600}h1,h2,h3,h4,h5,h6,strong,b{color:#222}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code,pre{font-family:fira mono,courier new,pingfang sc,source han sans sc,source han sans cn,noto sans cjk sc,wenquanyi micro hei,microsoft yahei,monospace!important}code{padding:.25em .5em;font-size:85%;color:#bf616a;background-color:#f9f9f9;border-radius:3px}pre{display:block;margin-top:0;margin-bottom:1rem;padding:1rem;font-size:.8rem;line-height:1.4;white-space:pre;white-space:pre-wrap;word-break:break-all;word-wrap:break-word;background-color:#f9f9f9;overflow-x:auto;tab-size:4;-moz-tab-size:4;padding:0}pre code{padding:0;font-size:100%;color:inherit;background-color:transparent}.highlight{margin-bottom:1rem;border-radius:4px}.highlight pre{margin-bottom:0}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:#8b6fcb}.nav{display:flex;align-items:baseline;flex-wrap:wrap;justify-content:space-between;margin-bottom:1rem}.nav-title{font-family:lora,sans-serif;font-size:1.5rem;color:#000;letter-spacing:-.055rem;font-weight:400;white-space:nowrap;text-decoration:none}.nav-links a{font-family:fira code,monospace;text-transform:lowercase;color:#b3b3b3;margin-right:2rem;font-weight:300;text-align:right;text-decoration:none}.nav-links a:last-of-type{margin-right:0}#TableOfContents{font-size:90%;margin-left:0!important;padding:.7em 1em;border-left:.25em solid rgba(9 9 9/.6);background-color:rgba(23 22 25/5%);margin:1em 0}#TableOfContents li{text-align:justify}#TableOfContents ul{list-style:none;line-height:1.6;padding-left:1em;margin:0}#TableOfContents ul ul{margin-block-start:0;margin-block-end:0}@media(prefers-color-scheme:dark){body{background-color:#333;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#8cc2dd}code{background-color:#777;color:#fff}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}.helptext{color:#aaa}.nav-title{color:#ddd}pre{background-color:#333}}</style><link rel=stylesheet href="https://fonts.googlefonts.cn/css?family=Fira+Mono|Roboto+Slab:400,600|Noto+Serif+SC:600|Lora:700&display=swap"><script async src=https://umami.clientinfra.com/fd5c29bd-10f7-4017-80c8-9d7aaf7c3e8b data-website-id=b25f85f7-169d-4949-9ce5-1d9cea51b28c></script><link href=https://cdn.bootcdn.net/ajax/libs/highlight.js/11.8.0/styles/base16/dracula.min.css rel=stylesheet><script src=https://cdn.bootcdn.net/ajax/libs/highlight.js/11.8.0/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script></head><body><header><nav class=nav><a class=nav-title href=https://clientinfra.com/>Client Infra</a><div class=nav-links><a href=/blog>Posts</a></div></nav></header><main><h1>使用 Gradle 解决 Android 模块化项目中的多语言支持</h1><p><i><time datetime=2023-06-29 pubdate>29 Jun, 2023</time></i></p><aside><nav id=TableOfContents><ul><li><a href=#切入点分析>切入点分析</a><ul><li><a href=#apk-中的-resourcesarsc>APK 中的 resources.arsc</a></li><li><a href=#aar-文件中的-rtxt-文件>AAR 文件中的 R.txt 文件</a></li><li><a href=#aar-文件中的-resvalues--目录>AAR 文件中的 res/values[-*] 目录</a></li></ul></li><li><a href=#动手去做>动手去做</a><ul><li><a href=#获取aar文件>获取AAR文件</a><ul><li><a href=#gradle-中的-configuration>Gradle 中的 Configuration</a></li><li><a href=#成功的尝试>成功的尝试</a></li></ul></li></ul></li><li><a href=#更进一步>更进一步</a><ul><li><a href=#agp-中的-transformaction>AGP 中的 TransformAction</a></li><li><a href=#gradle获取res目录>Gradle获取res目录</a></li></ul></li><li><a href=#最后>最后</a></li></ul></nav></aside><content><p>近年来越来越多的开发者和企业把目光聚焦于海外，寻求新的增长机会。然而对于一个“土生土长”的应用，想要在海外分一杯羹面临着诸多挑战，例如当地法律法规、网络环境、用户偏好等，其中最重要的恐怕就是"语言支持"了。据 Humans 分析统计，当一个APP被翻译成某一国家的母语后，收入会增加26%，下载量会提高120%。另外，如果一个 APP 支持英语、西语和中文三种语言，几乎能够覆盖全球50%的用户，可见语言支持的重要性。</p><p>为了支持多语言，通常需要将项目中所有的字符串资源提取，交给翻译人员，然后将翻译后的字符串资源导入到项目。而对于动辄上百个模块，轻则几十个模块的模块化项目来说，字符串资源会分布在各个模块，提取字符串资源的难度和模块的数量成正比。使用脚本扫描整个工程目录可能是最简单的方案——但对使用 <code>MultiRepo</code> 管理代码的工程，工程往往只依赖模块的aar，仅在开发过程中才会依赖源码，如果没有相应的基础设施，需要手动 <code>clone</code> 所有的模块源码，这无疑也是一件麻烦事。那么有没有一种方法，不需要繁琐的操作就可以让我们拿到对应的资源呢？</p><blockquote><p>对使用 Monorepo 或者非模块的工程，处理字符串资源并不是麻烦事，所以不在本文的讨论范围。</p></blockquote><h2 id=切入点分析>切入点分析</h2><p>对于字符串资源来说，同样一个词语，在不同的上下文中具有不同的含义，例如“好的“在聊天模块作为快捷回复用语翻译为 &ldquo;Okay&rdquo; ，在隐私协议界面作为接受约定翻译为 &ldquo;Agreed&rdquo; ，所以字符串资源所在的模块对于字符的翻译也是一个重要的辅助信息，导出时要包含所属模块信息。<br>而对于第三方比如 AndroidX 等库的字符串资源，有的是已翻译的，有的则没有必要翻译（内部调试页面），所以我们要在实际导出过程中排除这些字段。<br>结合上面两点，总结我们的需求就是：<strong>能够判断字符串资源属于哪个模块</strong>，有了这个前提我们可以很容易筛选出哪些是我们关注的模块内的资源，哪些资源我们不关心应该排除。带着这个目标，分析一下能达成此目标的切入点，从而确定最终的方案。</p><h3 id=apk-中的-resourcesarsc>APK 中的 resources.arsc</h3><p>resources.arsc 是 Android 资源构建的产物，得益于它和资源文件、以及 R字节码文件的同时存在于 APK 中，应用开发者才能够方便的以 <code>R.xxx.xxx</code> 直接获取到对应的资源。resources.arsc 在这一过程中担任了资源映射的角色，负责在实际运行中映射 R.java 的引用资源 id 到实际的资源，而字符串资源也由resources.arsc 负责映射，<code>R.string.xxx</code> 对应的字符串可以通过查询 resources.arsc 得到。</p><p>要判断 resources.arsc 能否满足我们的需求，就需要对 resources.arsc 的定义和结构有一定的认识，resource.arsc 由 AAPT2 构建资源文件后生成，阅读<a href=https://cs.android.com/android/platform/superproject/+/master:frameworks/base/tools/aapt2/>AAPT2 源码</a>是一种正统的途径，幸运的是由于Android开发工具链的完善，我们使用 Android Studio 的<a href="https://developer.android.com/studio/debug/apk-analyzer?hl=zh-cn">APK 分析器</a>，可以更容易的查看 resources.arsc 的结构。</p><p>以 Android Studio 新建一个默认项目为例，打包后通过 Android Studio 的<a href="https://developer.android.com/studio/debug/apk-analyzer?hl=zh-cn">APK 分析器</a>查看 resources.arsc 文件，从图中可以看到，resources.arsc 中的字符串资源没有所属模块的相关信息，并不能满足我们的需求，所以此方案不通。
<img src=https://img.clientinfra.com/client-infra-img/2024/02/e342cb02f809e5b705cfe914399158d6.png alt></p><h3 id=aar-文件中的-rtxt-文件>AAR 文件中的 R.txt 文件</h3><p>R.txt(Symbol List) 存在于 AAR 中，是 Android Library 资源构建的产物，负责在 Android 应用模块打包的过程中，传递给 Android 应用模块辅助生成模块所属的 R.class 字节码文件（为了防止资源 id 冲突，所以在 Android 应用模块打包过程中统一分配 id ）。</p><p>创建一个 Android Library 并增加几个字符串资源( <code>lib_name,test,test2</code> )然后打包成 AAR ,观察生成的R.txt 如图所示，R.txt 中列出了在 Android Library 中定义的所有字符串，并没有其他冗余信息。</p><p><img src=https://img.clientinfra.com/client-infra-img/2024/02/3a959f8134f7b46c4c9efdd198f30a73.png alt></p><p>由于我们是从 AAR 文件中获取资源，所以判断模块归属十分容易（从AAR文件名获取），R.txt + resources.arsc 的组合是否能够满足以上需求呢？</p><p>不幸的是，由于 APG 和 Android Studio 不断优化的性能和体验，导致我们产生了“错觉”—— R.txt 内容其实和 <code>android.nonTransitiveRClass</code> 变量的赋值有关，此属性在 Android Studio Bumblebee 后<a href="https://developer.android.com/studio/releases/past-releases/as-bumblebee-release-notes?hl=zh-cn#rclasses-default">默认开启</a>，
而我们的实验代码正是在 Android Studio Bumblebee 之后的版本上创建的，也就默认开启了"非传递性 R 类"。如果我们尝试使用 <code>android.nonTransitiveRClass</code> 的默认值（ false ）重新构建 AAR ,发现导出的 R.txt “膨胀”了
（将三方库的字符串资源也包含在内），也就没办法满足需求。
<img src=https://img.clientinfra.com/client-infra-img/2024/02/f2c5faa2d7e7c78a646acd394e23eea2.png alt></p><p>Android Studio Bumblebee 是在2022年1月发布的，而我们的项目创建远远早于这个时间，如果想开启“非传递性 R 类”，就需要利用 Android Studio Arctic Fox 及以上版本使用重构工具来启用，这对于我们来说代价同样过大，同样放弃该方案。</p><p>从长远来看，遵循 Google 最佳实践可以帮助我们更好地优化应用程序，以快速、高效地满足用户需求。因为需求排期等原因，我们选择排期迁移到“非传递 R 类”。</p><h3 id=aar-文件中的-resvalues--目录>AAR 文件中的 res/values[-*] 目录</h3><p>查阅<a href="https://developer.android.com/studio/projects/android-library?hl=zh-cn#aar-contents"> AAR 文档</a>发现,每一个 AAR 文件除了必须包含 /AndroidManifest.xml 还可能包含 /res/ 目录，继续使用上文中使用的 Android Library 并增加一些字段加以测试，打包成AAR后查看 /res/values 目录发现，在AAR中，将原本 values 目录下的所有值合成到了一个文件 values.xml 中，而对于其他语言区域的支持 /res/values-en-rUS 目录也相应的生成了 values-en-rUS.xml 文件。</p><p>AAR 的 res/values[-* ] 目录中包含了仅在此模块定义的字符串资源，符合我们的需求。所以我们确定方案为<strong>从模块的 AAR 的 res/values[-* ] 目录中提取并解析 value[-* ].xml 以获得的模块的所有字符串资源</strong>。</p><p><img src=https://img.clientinfra.com/client-infra-img/2024/02/2e55bc1cf7cc0e548144ee58d7fafe66.png alt></p><h2 id=动手去做>动手去做</h2><h3 id=获取aar文件>获取AAR文件</h3><p>从前面的分析中，我们发现 AAR 中的 res 目录是最佳的切入点，但是在实际的研发过程中，得益于 Gradle 的依赖管理，我们仅需要一条简单的 <code>implementation</code> 就可以将 AAR/JAR 依赖进工程，并不需要我们手动下载并依赖AAR文件，也就导致我们没有机会拿到 AAR 。要想知道 <code>implementation</code> 是怎么做到的，就需要先了解什么是<code>implementation</code>，我们每天都在使用它，却从未揭开他的神秘面纱。</p><h4 id=gradle-中的-configuration>Gradle 中的 Configuration</h4><p><code>implementation</code> 其实是 <a href=https://docs.gradle.org/current/userguide/java_plugin.html#sec:java_plugin_and_dependency_management>Java Plugin</a> 定义的一个 <a href=https://docs.gradle.org/current/dsl/org.gradle.api.artifacts.Configuration.html>Configuration</a> ，Gradle 中为了满足不同的构建需求，使用Configuration 的概念来帮助表示依赖项作用的范围。如图中所示， <code>implementation</code> 表示用于源代码编译的依赖项，而 <code>testRuntime</code> 负责表示执行测试所需的依赖项。归根结底，他们是作用于不同构建的依赖项集合。</p><blockquote><p>需要说明的是： AGP 中的 <code>implementation</code> 和 <code>api</code> 等配置复用了 Java Plugin 中的配置定义。</p></blockquote><p><img src=https://img.clientinfra.com/client-infra-img/2024/02/84708cc06035d723a36ce6e17e5ff454.png alt></p><p>了解了 <code>implementation</code> 其实是一个 Configuration ，查阅文档可以使用 <a href=https://docs.gradle.org/current/javadoc/org/gradle/api/artifacts/ConfigurationContainer.html#getByName-java.lang.String-><code>configurations.getByName()</code></a> 查找到对应的 Configuration 实例，并尝试使用<a href=https://docs.gradle.org/current/javadoc/org/gradle/api/artifacts/Configuration.html#resolve--><code>Configuration.resolve()</code></a>查找并下载构成此配置的文件，返回结果文件集（这里的文件集就是 AAR/JAR 等依赖项文件）。于是在 build.gradle(module) 写下了下面的代码并运行,随即 IDE 抛出了异常 <code>'implementation' is not allowed as it is defined as 'canBeResolved=false'.</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=n>afterEvaluate</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>configuration</span> <span class=p>=</span> <span class=n>configurations</span><span class=p>.</span><span class=n>getByName</span><span class=p>(</span><span class=s2>&#34;implementation&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>resolve</span> <span class=p>=</span> <span class=n>configuration</span><span class=p>.</span><span class=n>resolve</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>resolve</span><span class=p>.</span><span class=n>forEach</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>println</span><span class=p>(</span><span class=k>it</span><span class=p>.</span><span class=n>absolutePath</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>#</span> <span class=n>Console</span> <span class=n>Error</span> <span class=err>#</span>
</span></span><span class=line><span class=cl><span class=n>A</span> <span class=n>problem</span> <span class=n>occurred</span> <span class=n>configuring</span> <span class=n>project</span> <span class=err>&#39;</span><span class=p>:</span><span class=n>app</span><span class=err>&#39;</span><span class=p>.</span>
</span></span><span class=line><span class=cl><span class=p>&gt;</span> <span class=n>Resolving</span> <span class=n>dependency</span> <span class=n>configuration</span> <span class=err>&#39;</span><span class=n>implementation</span><span class=err>&#39;</span> <span class=k>is</span> <span class=n>not</span> <span class=n>allowed</span> <span class=k>as</span> <span class=k>it</span> <span class=k>is</span> <span class=n>defined</span> <span class=k>as</span> <span class=err>&#39;</span><span class=n>canBeResolved</span><span class=p>=</span><span class=k>false</span><span class=err>&#39;</span><span class=p>.</span>
</span></span><span class=line><span class=cl>  <span class=n>Instead</span><span class=p>,</span> <span class=n>a</span> <span class=n>resolvable</span> <span class=p>(</span><span class=err>&#39;</span><span class=n>canBeResolved</span><span class=p>=</span><span class=k>true</span><span class=err>&#39;</span><span class=p>)</span> <span class=n>dependency</span> <span class=n>configuration</span> <span class=n>that</span> <span class=n>extends</span> <span class=err>&#39;</span><span class=n>implementation</span><span class=err>&#39;</span> <span class=n>should</span> <span class=n>be</span> <span class=n>resolved</span><span class=p>.</span>
</span></span></code></pre></div><p>出现错误的原因是因为 <code>implementation</code> 将自己的 <code>canBeResolved</code> 属性设置为 <code>false</code> ，这就禁止了对这个 Configuration 进行任何解析，如果尝试解析就会抛出异常。如果我们拿不到依赖项，那么 AGP 插件是怎么获取到依赖项并成功打包的呢？答案就是通过"配置继承( Configuration inheritance )"——在 Gradle 中为了复用 Configuration ，可以使用"配置继承"扩展其他配置以形成继承层次结构。子 Configuration 继承在父Configuration 中声明的整套依赖项。所以我们可以尝试解析 <code>implementation</code> 的子 Configuration 来达到获取 <code>implementation</code> 的依赖项的目的。</p><p>通过翻阅源码发现，AGP 创建了一个 <code>${variantName}CompileClasspath</code> 的 Configuration 去继承 <code>compileOnly</code> 和 <code>implementation</code> ，由于 Configuration 的 <code>canBeResolved</code> 默认值为 <code>true</code> ， <code>${variantName}CompileClasspath</code> 并没有将自己的 <code>canBeResolved</code> 置为 <code>false</code> ，所以我们可以通过解析这个 Configuration 来获取依赖项。<code>variantName</code> 是构建变种名，默认会创建 release 和 debug 变种，这里我们选用 <strong>releaseCompileClasspath</strong> ，通过代码分析配置之间的依赖关系如下图</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//已忽略无关代码</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//https://cs.android.com/android-studio/platform/tools/base/+/mirror-goog-studio-main:build-system/gradle-core/src/main/java/com/android/build/gradle/internal/dependency/VariantDependenciesBuilder.java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>package</span><span class=w> </span><span class=nn>com.android.build.gradle.internal.dependency</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>VariantDependenciesBuilder</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>Configuration</span><span class=o>&gt;</span><span class=w> </span><span class=n>compileClasspaths</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Sets</span><span class=p>.</span><span class=na>newLinkedHashSet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>VariantDependenciesBuilder</span><span class=w> </span><span class=nf>addSourceSet</span><span class=p>(</span><span class=nd>@Nullable</span><span class=w> </span><span class=n>DefaultAndroidSourceSet</span><span class=w> </span><span class=n>sourceSet</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>....</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//获取compileOnly </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>compileClasspaths</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>configs</span><span class=p>.</span><span class=na>getByName</span><span class=p>(</span><span class=n>sourceSet</span><span class=p>.</span><span class=na>getCompileOnlyConfigurationName</span><span class=p>()));</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//获取implementation</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>Configuration</span><span class=w> </span><span class=n>implementationConfig</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>configs</span><span class=p>.</span><span class=na>getByName</span><span class=p>(</span><span class=n>sourceSet</span><span class=p>.</span><span class=na>getImplementationConfigurationName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>compileClasspaths</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>implementationConfig</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>....</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>VariantDependencies</span><span class=w> </span><span class=nf>build</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>ConfigurationContainer</span><span class=w> </span><span class=n>configurations</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>project</span><span class=p>.</span><span class=na>getConfigurations</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>DependencyHandler</span><span class=w> </span><span class=n>dependencies</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>project</span><span class=p>.</span><span class=na>getDependencies</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>compileClasspathName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>variantName</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;CompileClasspath&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Configuration</span><span class=w> </span><span class=n>compileClasspath</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>configurations</span><span class=p>.</span><span class=na>maybeCreate</span><span class=p>(</span><span class=n>compileClasspathName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>compileClasspath</span><span class=p>.</span><span class=na>setVisible</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>compileClasspath</span><span class=p>.</span><span class=na>setDescription</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=s>&#34;Resolved configuration for compilation for variant: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>variantName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>compileClasspath</span><span class=p>.</span><span class=na>setExtendsFrom</span><span class=p>(</span><span class=n>compileClasspaths</span><span class=p>);</span><span class=w> </span><span class=c1>//设置配置继承关系</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>compileClasspath</span><span class=p>.</span><span class=na>setCanBeConsumed</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>compileClasspath</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>getResolutionStrategy</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>sortArtifacts</span><span class=p>(</span><span class=n>ResolutionStrategy</span><span class=p>.</span><span class=na>SortOrder</span><span class=p>.</span><span class=na>CONSUMER_FIRST</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><img src=https://img.clientinfra.com/client-infra-img/2024/02/77f4f3870c1abb92b1737083a77b0e50.png alt></p><p>从依赖关系图可以看出，对于 <code>releaseImplementation</code> 和 <code>releaseApi</code> 等依赖方式，使用 <code>releaseCompileClasspath</code> 同样也能获取到对应的依赖项,通常 <code>implementation</code> 等不可解析对象仅作为定义存在。可解析配置将扩展至少一个不可解析的配置（并且可以扩展多个配置）。</p><h4 id=成功的尝试>成功的尝试</h4><p>基于分析，我们重新修改获取 AAR 逻辑,可以看到在控制台成功输出了所有依赖项的路径。接下来，我们筛选出我们需要翻译的模块 AAR ，解压到临时文件，并解析 res/values[-*] 目录下的 xml 文件，那么该模块下所有的已有的字符串资源就已经被成功获取了，导出的格式选择就取决于产品或者翻译平台的格式要求。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=n>dependencies</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>    <span class=n>implementation</span><span class=p>(</span><span class=s2>&#34;androidx.core:core-ktx:1.9.0&#34;</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>    <span class=n>releaseImplementation</span><span class=p>(</span><span class=s2>&#34;com.squareup.okhttp3:okhttp:4.11.0&#34;</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>    <span class=n>testImplementation</span><span class=p>(</span><span class=n>libs</span><span class=p>.</span><span class=n>junit</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>    <span class=n>androidTestImplementation</span><span class=p>(</span><span class=n>libs</span><span class=p>.</span><span class=n>androidx</span><span class=p>.</span><span class=n>test</span><span class=p>.</span><span class=n>ext</span><span class=p>.</span><span class=n>junit</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>    <span class=n>androidTestImplementation</span><span class=p>(</span><span class=n>libs</span><span class=p>.</span><span class=n>espresso</span><span class=p>.</span><span class=n>core</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=n>afterEvaluate</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>configuration</span> <span class=p>=</span> <span class=n>configurations</span><span class=p>.</span><span class=n>getByName</span><span class=p>(</span><span class=s2>&#34;releaseRuntimeClasspath&#34;</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>resolve</span> <span class=p>=</span> <span class=n>configuration</span><span class=p>.</span><span class=n>resolve</span><span class=p>()</span>  
</span></span><span class=line><span class=cl>    <span class=n>resolve</span><span class=p>.</span><span class=n>forEach</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>        <span class=n>println</span><span class=p>(</span><span class=k>it</span><span class=p>.</span><span class=n>absolutePath</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>    <span class=p>}</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>#</span> <span class=n>Console</span> <span class=n>Output</span> <span class=err>#</span>
</span></span><span class=line><span class=cl><span class=p>&gt;</span> <span class=n>Configure</span> <span class=n>project</span> <span class=p>:</span><span class=n>app</span>
</span></span><span class=line><span class=cl><span class=p>/</span><span class=n>home</span><span class=p>/</span><span class=n>prosixe</span><span class=p>/.</span><span class=n>gradle</span><span class=p>/</span><span class=n>caches</span><span class=p>/</span><span class=n>modules</span><span class=p>-</span><span class=m>2</span><span class=p>/</span><span class=n>files</span><span class=p>-</span><span class=m>2.1</span><span class=p>/</span><span class=n>com</span><span class=p>.</span><span class=n>squareup</span><span class=p>.</span><span class=n>okhttp3</span><span class=p>/</span><span class=n>okhttp</span><span class=p>/</span><span class=m>4.11</span><span class=p>.</span><span class=m>0</span><span class=p>/</span><span class=m>436932</span><span class=n>d695b2c43f2c86b8111c596179cd133d56</span><span class=p>/</span><span class=n>okhttp</span><span class=p>-</span><span class=m>4.11</span><span class=p>.</span><span class=m>0.</span><span class=n>jar</span>
</span></span><span class=line><span class=cl><span class=p>/</span><span class=n>home</span><span class=p>/</span><span class=n>prosixe</span><span class=p>/.</span><span class=n>gradle</span><span class=p>/</span><span class=n>caches</span><span class=p>/</span><span class=n>modules</span><span class=p>-</span><span class=m>2</span><span class=p>/</span><span class=n>files</span><span class=p>-</span><span class=m>2.1</span><span class=p>/</span><span class=n>com</span><span class=p>.</span><span class=n>squareup</span><span class=p>.</span><span class=n>okio</span><span class=p>/</span><span class=n>okio</span><span class=p>-</span><span class=n>jvm</span><span class=p>/</span><span class=m>3.2</span><span class=p>.</span><span class=m>0</span><span class=p>/</span><span class=m>332</span><span class=n>d1c5dc82b0241cb1d35bb0901d28470cc89ca</span><span class=p>/</span><span class=n>okio</span><span class=p>-</span><span class=n>jvm</span><span class=p>-</span><span class=m>3.2</span><span class=p>.</span><span class=m>0.</span><span class=n>jar</span>
</span></span><span class=line><span class=cl><span class=p>/</span><span class=n>home</span><span class=p>/</span><span class=n>prosixe</span><span class=p>/.</span><span class=n>gradle</span><span class=p>/</span><span class=n>caches</span><span class=p>/</span><span class=n>modules</span><span class=p>-</span><span class=m>2</span><span class=p>/</span><span class=n>files</span><span class=p>-</span><span class=m>2.1</span><span class=p>/</span><span class=n>org</span><span class=p>.</span><span class=n>jetbrains</span><span class=p>.</span><span class=n>kotlin</span><span class=p>/</span><span class=n>kotlin</span><span class=p>-</span><span class=n>stdlib</span><span class=p>-</span><span class=n>jdk8</span><span class=p>/</span><span class=m>1.8</span><span class=p>.</span><span class=m>0</span><span class=p>/</span><span class=n>ed04f49e186a116753ad70d34f0ac2925d1d8020</span><span class=p>/</span><span class=n>kotlin</span><span class=p>-</span><span class=n>stdlib</span><span class=p>-</span><span class=n>jdk8</span><span class=p>-</span><span class=m>1.8</span><span class=p>.</span><span class=m>0.</span><span class=n>jar</span>
</span></span><span class=line><span class=cl><span class=p>/</span><span class=n>home</span><span class=p>/</span><span class=n>prosixe</span><span class=p>/.</span><span class=n>gradle</span><span class=p>/</span><span class=n>caches</span><span class=p>/</span><span class=n>modules</span><span class=p>-</span><span class=m>2</span><span class=p>/</span><span class=n>files</span><span class=p>-</span><span class=m>2.1</span><span class=p>/</span><span class=n>androidx</span><span class=p>.</span><span class=n>core</span><span class=p>/</span><span class=n>core</span><span class=p>/</span><span class=m>1.9</span><span class=p>.</span><span class=m>0</span><span class=p>/</span><span class=n>aa21c91d72e5d2a8dcc00c029ec65fc8d804ce02</span><span class=p>/</span><span class=n>core</span><span class=p>-</span><span class=m>1.9</span><span class=p>.</span><span class=m>0.</span><span class=n>aar</span>
</span></span><span class=line><span class=cl><span class=p>/</span><span class=n>home</span><span class=p>/</span><span class=n>prosixe</span><span class=p>/.</span><span class=n>gradle</span><span class=p>/</span><span class=n>caches</span><span class=p>/</span><span class=n>modules</span><span class=p>-</span><span class=m>2</span><span class=p>/</span><span class=n>files</span><span class=p>-</span><span class=m>2.1</span><span class=p>/</span><span class=n>androidx</span><span class=p>.</span><span class=n>core</span><span class=p>/</span><span class=n>core</span><span class=p>-</span><span class=n>ktx</span><span class=p>/</span><span class=m>1.9</span><span class=p>.</span><span class=m>0</span><span class=p>/</span><span class=n>b56f6b1bcb7882a9933c963907818da2094ae3a4</span><span class=p>/</span><span class=n>core</span><span class=p>-</span><span class=n>ktx</span><span class=p>-</span><span class=m>1.9</span><span class=p>.</span><span class=m>0.</span><span class=n>aar</span>
</span></span><span class=line><span class=cl><span class=p>/</span><span class=n>home</span><span class=p>/</span><span class=n>prosixe</span><span class=p>/.</span><span class=n>gradle</span><span class=p>/</span><span class=n>caches</span><span class=p>/</span><span class=n>modules</span><span class=p>-</span><span class=m>2</span><span class=p>/</span><span class=n>files</span><span class=p>-</span><span class=m>2.1</span><span class=p>/</span><span class=n>org</span><span class=p>.</span><span class=n>jetbrains</span><span class=p>.</span><span class=n>kotlin</span><span class=p>/</span><span class=n>kotlin</span><span class=p>-</span><span class=n>stdlib</span><span class=p>-</span><span class=n>jdk7</span><span class=p>/</span><span class=m>1.8</span><span class=p>.</span><span class=m>0</span><span class=p>/</span><span class=m>3</span><span class=n>c91271347f678c239607abb676d4032a7898427</span><span class=p>/</span><span class=n>kotlin</span><span class=p>-</span><span class=n>stdlib</span><span class=p>-</span><span class=n>jdk7</span><span class=p>-</span><span class=m>1.8</span><span class=p>.</span><span class=m>0.</span><span class=n>jar</span>
</span></span><span class=line><span class=cl><span class=p>/</span><span class=n>home</span><span class=p>/</span><span class=n>prosixe</span><span class=p>/.</span><span class=n>gradle</span><span class=p>/</span><span class=n>caches</span><span class=p>/</span><span class=n>modules</span><span class=p>-</span><span class=m>2</span><span class=p>/</span><span class=n>files</span><span class=p>-</span><span class=m>2.1</span><span class=p>/</span><span class=n>androidx</span><span class=p>.</span><span class=k>annotation</span><span class=p>/</span><span class=k>annotation</span><span class=p>-</span><span class=n>experimental</span><span class=p>/</span><span class=m>1.3</span><span class=p>.</span><span class=m>0</span><span class=p>/</span><span class=m>5087</span><span class=n>c6f545117dcd474e69e1a93cacec9d7334af</span><span class=p>/</span><span class=k>annotation</span><span class=p>-</span><span class=n>experimental</span><span class=p>-</span><span class=m>1.3</span><span class=p>.</span><span class=m>0.</span><span class=n>aar</span>
</span></span><span class=line><span class=cl><span class=o>....</span>
</span></span></code></pre></div><h2 id=更进一步>更进一步</h2><p>大家都知道，Android 打包过程中资源和源码分别有不同的编译流程，那么在打包的过程中肯定不是让 AAR 整个文件直接参与打包流程的，如果是资源和源码分别参与到流程中，那么它们的中间文件放置在哪里呢？如果我们找到了中间文件是不是就可以免去解压这个步骤，直接解析提取了呢？带着问题，我们从源码中寻找答案。</p><h3 id=agp-中的-transformaction>AGP 中的 TransformAction</h3><p>TransformAction 是 Gradle 中负责转换工件( Artifact ，在Gradle中通常表示一个构建产物，例如 AAR,JAR,WAR 等等)的 API ，通常负责将一组属性( Attributes )转到另一组属性。当 Gradle 尝试去解析一个 Configuration 的时候，如果某些依赖项并没有请求属性的对应变体的时候，Gradle 会从已注册 <code>registerTransform</code> 的 TransformAction 中尝试找到一条组合路径，能够将现有的依赖项转换为带有请求属性的依赖项目。举个例子: 在 Android 编译过程中，<code>android.enableJetifier=true</code> 时，假设请求的属性为 PROCESSED_AAR ，而我们依赖项的现有属性为 AAR ,那么 Gradle 会找到一条 TransformAction 组合路径，能从 AAR 转换为 PROCESSED_AAR 。</p><p>需要注意的是 <code>artifactType</code> 属性很特殊，因为它仅存在于已解析的工件上，而不存在于依赖项上。因此，在解析仅有 <code>artifactType</code> 请求属性的配置时，任何只修改 <code>artifactType</code> 属性的 TransformAction 将不会被选中。只有在使用<code>ArtifactView</code>时才会考虑选中。</p><p>通过在AGP中查找 TransformAction 的定义和注册，发现AGP中有两个 TransformAction 子类和 AAR 解压和解析有关。他们分别是<a href=https://cs.android.com/android-studio/platform/tools/base/+/mirror-goog-studio-main:build-system/gradle-core/src/main/java/com/android/build/gradle/internal/dependency/ExtractAarTransform.kt> ExtractAarTransform </a>和<a href=https://cs.android.com/android-studio/platform/tools/base/+/mirror-goog-studio-main:build-system/gradle-core/src/main/java/com/android/build/gradle/internal/dependency/AarTransform.java> AarTransform </a>，通过分析代码发现 ExtractAarTransform 负责将输入AAR文件解压,而 AarTransform 负责返回AAR解压文件夹中某个资源的路径。分析他们的 <code>registerTransform</code> 代码发现，如果我们想从 <code>AndroidArtifacts.ArtifactType.AAR</code> 属性转到 <code>AndroidArtifacts.ArtifactType.ANDROID_RES</code>属性，由 ExtractAarTransform 和 AarTransform 组合正好能构成一条转换路径（ AAR -> EXPLODED_AAR -> ANDROID_RES ）</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//代码地址:https://cs.android.com/android-studio/platform/tools/base/+/mirror-goog-studio-main:build-system/gradle-core/src/main/java/com/android/build/gradle/internal/DependencyConfigurator.kt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//ExtractAarTransform的注册</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>registerTransform</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ExtractAarTransform</span><span class=p>::</span><span class=kd>class</span><span class=err>.</span><span class=nc>java</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>aarOrJarTypeToConsume</span><span class=p>.</span><span class=na>aar</span><span class=p>,</span><span class=c1>//AndroidArtifacts.ArtifactType.AAR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>AndroidArtifacts</span><span class=p>.</span><span class=na>ArtifactType</span><span class=p>.</span><span class=na>EXPLODED_AAR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//AarTransform的注册 getTransformTargets是不同的转换目标属性，循环注册</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>transformTarget</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=n>AarTransform</span><span class=p>.</span><span class=na>getTransformTargets</span><span class=p>(</span><span class=n>aarOrJarTypeToConsume</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>dependencies</span><span class=p>.</span><span class=na>registerTransform</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>AarTransform</span><span class=p>::</span><span class=kd>class</span><span class=err>.</span><span class=nc>java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>spec</span><span class=w> </span><span class=o>-&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>spec</span><span class=p>.</span><span class=na>from</span><span class=p>.</span><span class=na>attribute</span><span class=p>(</span><span class=n>ArtifactTypeDefinition</span><span class=p>.</span><span class=na>ARTIFACT_TYPE_ATTRIBUTE</span><span class=p>,</span><span class=w> </span><span class=n>AndroidArtifacts</span><span class=p>.</span><span class=na>ArtifactType</span><span class=p>.</span><span class=na>EXPLODED_AAR</span><span class=p>.</span><span class=na>type</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>spec</span><span class=p>.</span><span class=na>from</span><span class=p>.</span><span class=na>attribute</span><span class=p>(</span><span class=n>Category</span><span class=p>.</span><span class=na>CATEGORY_ATTRIBUTE</span><span class=p>,</span><span class=w> </span><span class=n>libraryCategory</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>spec</span><span class=p>.</span><span class=na>to</span><span class=p>.</span><span class=na>attribute</span><span class=p>(</span><span class=n>ArtifactTypeDefinition</span><span class=p>.</span><span class=na>ARTIFACT_TYPE_ATTRIBUTE</span><span class=p>,</span><span class=w> </span><span class=n>transformTarget</span><span class=p>.</span><span class=na>type</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>spec</span><span class=p>.</span><span class=na>to</span><span class=p>.</span><span class=na>attribute</span><span class=p>(</span><span class=n>Category</span><span class=p>.</span><span class=na>CATEGORY_ATTRIBUTE</span><span class=p>,</span><span class=w> </span><span class=n>libraryCategory</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>spec</span><span class=p>.</span><span class=na>parameters</span><span class=p>.</span><span class=na>projectName</span><span class=p>.</span><span class=na>setDisallowChanges</span><span class=p>(</span><span class=n>project</span><span class=p>.</span><span class=na>name</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>spec</span><span class=p>.</span><span class=na>parameters</span><span class=p>.</span><span class=na>targetType</span><span class=p>.</span><span class=na>setDisallowChanges</span><span class=p>(</span><span class=n>transformTarget</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>spec</span><span class=p>.</span><span class=na>parameters</span><span class=p>.</span><span class=na>sharedLibSupport</span><span class=p>.</span><span class=na>setDisallowChanges</span><span class=p>(</span><span class=n>sharedLibSupport</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>----</span><span class=n>From</span><span class=w> </span><span class=n>AarTransform</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@NonNull</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>ArtifactType</span><span class=o>[]</span><span class=w> </span><span class=nf>getTransformTargets</span><span class=p>(</span><span class=n>AarOrJarTypeToConsume</span><span class=w> </span><span class=n>aarOrJarTypeToConsume</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArtifactType</span><span class=o>[]</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>aarOrJarTypeToConsume</span><span class=p>.</span><span class=na>getJar</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// For CLASSES, this transform is ues for runtime, and AarCompileClassesTransform is</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// used for compile</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ArtifactType</span><span class=p>.</span><span class=na>SHARED_CLASSES</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ArtifactType</span><span class=p>.</span><span class=na>JAVA_RES</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ArtifactType</span><span class=p>.</span><span class=na>SHARED_JAVA_RES</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ArtifactType</span><span class=p>.</span><span class=na>MANIFEST</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ArtifactType</span><span class=p>.</span><span class=na>ANDROID_RES</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ArtifactType</span><span class=p>.</span><span class=na>ASSETS</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ArtifactType</span><span class=p>.</span><span class=na>SHARED_ASSETS</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ArtifactType</span><span class=p>.</span><span class=na>JNI</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ArtifactType</span><span class=p>.</span><span class=na>SHARED_JNI</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ArtifactType</span><span class=p>.</span><span class=na>AIDL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ArtifactType</span><span class=p>.</span><span class=na>RENDERSCRIPT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ArtifactType</span><span class=p>.</span><span class=na>UNFILTERED_PROGUARD_RULES</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ArtifactType</span><span class=p>.</span><span class=na>LINT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ArtifactType</span><span class=p>.</span><span class=na>ANNOTATIONS</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ArtifactType</span><span class=p>.</span><span class=na>PUBLIC_RES</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ArtifactType</span><span class=p>.</span><span class=na>COMPILE_SYMBOL_LIST</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ArtifactType</span><span class=p>.</span><span class=na>DATA_BINDING_ARTIFACT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ArtifactType</span><span class=p>.</span><span class=na>DATA_BINDING_BASE_CLASS_LOG_ARTIFACT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ArtifactType</span><span class=p>.</span><span class=na>RES_STATIC_LIBRARY</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ArtifactType</span><span class=p>.</span><span class=na>RES_SHARED_STATIC_LIBRARY</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ArtifactType</span><span class=p>.</span><span class=na>PREFAB_PACKAGE</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ArtifactType</span><span class=p>.</span><span class=na>AAR_METADATA</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ArtifactType</span><span class=p>.</span><span class=na>ART_PROFILE</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ArtifactType</span><span class=p>.</span><span class=na>NAVIGATION_JSON</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>上文提到，要想触发<code>artifactType</code>的属性转换，需要我们使用<code>ArtifactView</code>，<code>AndroidArtifacts.ArtifactType.AAR</code> 和 <code>AndroidArtifacts.ArtifactType.ANDROID_RES</code> 属性就是 <code>artifactType</code> 的属性,这一点可以从 <code>AndroidArtifacts</code> <a href=https://cs.android.com/android-studio/platform/tools/base/+/mirror-goog-studio-main:build-system/gradle-core/src/main/java/com/android/build/gradle/internal/publishing/AndroidArtifacts.java>源码</a>得知,所以修改获取方式如下，并成功获取了位于 Gradle 缓存路径下的已解压的 AAR 路径，现在我们不用解压缩，就可以拿到一个模块下所有的字符串资源了。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=n>afterEvaluate</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>configuration</span> <span class=p>=</span> <span class=n>configurations</span><span class=p>.</span><span class=n>getByName</span><span class=p>(</span><span class=s2>&#34;releaseRuntimeClasspath&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>artifacts</span> <span class=p>=</span> <span class=n>configuration</span><span class=p>.</span><span class=n>incoming</span><span class=p>.</span><span class=n>artifactView</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>attributes</span><span class=p>.</span><span class=n>attribute</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=nc>AndroidArtifacts</span><span class=p>.</span><span class=n>ARTIFACT_TYPE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nc>AndroidArtifacts</span><span class=p>.</span><span class=nc>ArtifactType</span><span class=p>.</span><span class=nc>ANDROID_RES</span><span class=p>.</span><span class=n>type</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}.</span><span class=n>artifacts</span>
</span></span><span class=line><span class=cl>    <span class=n>artifacts</span><span class=p>.</span><span class=n>artifactFiles</span><span class=p>.</span><span class=n>forEach</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>println</span><span class=p>(</span><span class=k>it</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>#</span><span class=n>output</span> 
</span></span><span class=line><span class=cl><span class=p>/</span><span class=n>home</span><span class=p>/</span><span class=n>prosixe</span><span class=p>/.</span><span class=n>gradle</span><span class=p>/</span><span class=n>caches</span><span class=p>/</span><span class=n>transforms</span><span class=p>-</span><span class=m>3</span><span class=p>/</span><span class=n>b15e5c11ab5458dc40071e292632fa4c</span><span class=p>/</span><span class=n>transformed</span><span class=p>/</span><span class=n>core</span><span class=p>-</span><span class=m>1.9</span><span class=p>.</span><span class=m>0</span><span class=p>/</span><span class=n>res</span>
</span></span><span class=line><span class=cl><span class=p>/</span><span class=n>home</span><span class=p>/</span><span class=n>prosixe</span><span class=p>/.</span><span class=n>gradle</span><span class=p>/</span><span class=n>caches</span><span class=p>/</span><span class=n>transforms</span><span class=p>-</span><span class=m>3</span><span class=p>/</span><span class=m>5409291</span><span class=n>e0f20302a556f1f822f907835</span><span class=p>/</span><span class=n>transformed</span><span class=p>/</span><span class=n>core</span><span class=p>-</span><span class=n>ktx</span><span class=p>-</span><span class=m>1.9</span><span class=p>.</span><span class=m>0</span><span class=p>/</span><span class=n>res</span>
</span></span><span class=line><span class=cl><span class=p>/</span><span class=n>home</span><span class=p>/</span><span class=n>prosixe</span><span class=p>/.</span><span class=n>gradle</span><span class=p>/</span><span class=n>caches</span><span class=p>/</span><span class=n>transforms</span><span class=p>-</span><span class=m>3</span><span class=p>/</span><span class=m>7589258</span><span class=n>eaf55d137a37e590e9111e0d3</span><span class=p>/</span><span class=n>transformed</span><span class=p>/</span><span class=k>annotation</span><span class=p>-</span><span class=n>experimental</span><span class=p>-</span><span class=m>1.3</span><span class=p>.</span><span class=m>0</span><span class=p>/</span><span class=n>res</span>
</span></span><span class=line><span class=cl><span class=p>/</span><span class=n>home</span><span class=p>/</span><span class=n>prosixe</span><span class=p>/.</span><span class=n>gradle</span><span class=p>/</span><span class=n>caches</span><span class=p>/</span><span class=n>transforms</span><span class=p>-</span><span class=m>3</span><span class=p>/</span><span class=m>67</span><span class=n>e97da11edfa018e3236656720b711b</span><span class=p>/</span><span class=n>transformed</span><span class=p>/</span><span class=n>lifecycle</span><span class=p>-</span><span class=n>runtime</span><span class=p>-</span><span class=m>2.3</span><span class=p>.</span><span class=m>1</span><span class=p>/</span><span class=n>res</span>
</span></span></code></pre></div><h3 id=gradle获取res目录>Gradle获取res目录</h3><p>通常翻译后的字符需要导入到源码路径，使用 Gradle 插件可以很好的完成这一任务，甚至定制插件可以让你在打包时拥有更多的灵活性,如果你想在 Gradle 中获取项目的资源路径，如果你的项目有多个变种，写死路径的方式可能并不是那么优美，你可以使用 Gradle 的 API 去获取，针对不同的变种修改 <code>findByName</code> 的值就可以轻松实现。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>val</span> <span class=py>extension</span> <span class=p>=</span> <span class=n>project</span><span class=p>.</span><span class=n>extensions</span><span class=p>.</span><span class=n>getByName</span><span class=p>(</span><span class=s2>&#34;android&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>BaseExtension</span>  
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=py>sourceSets</span> <span class=p>=</span> <span class=n>extension</span><span class=p>.</span><span class=n>sourceSets</span>  
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=py>mainSourceSets</span> <span class=p>=</span> <span class=n>sourceSets</span><span class=p>.</span><span class=n>findByName</span><span class=p>(</span><span class=s2>&#34;main&#34;</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=py>dirs</span> <span class=p>=</span> <span class=n>mainSourceSets</span><span class=o>!!</span><span class=p>.</span><span class=n>res</span><span class=p>.</span><span class=n>srcDirs</span>
</span></span></code></pre></div><h2 id=最后>最后</h2><p>本文通过一个实际的需求引导读者一步步深入思考和解决问题。虽然最终的解决方案仅需几行代码，但这个过程对于培养解决问题的能力非常有价值。当面对问题时，如果在搜索引擎中无法找到现成的解决方案，不妨静下心来，深入研究源代码，去挖掘其中潜藏的宝藏。</p><p>Android生态是一个开放的世界，除了Android系统源码之外，你还可以在https://cs.android.com/ 找到Android Studio、AndroidX等相关工具和库的源代码。善于利用这些资源，将有助于你更好地理解Android开发，并提升自己的技术水平。在实践中不断挑战和突破自己，是成为一名优秀Android开发者的关键。</p></content><p><a href=https://clientinfra.com/blog/gradle/>#Gradle</a>
<a href=https://clientinfra.com/blog/android/>#Android</a></p><script src=https://giscus.app/client.js data-repo=nodmp/nodmp.github.io data-repo-id=R_kgDOLXPtcw data-category=Announcements data-category-id=DIC_kwDOLXPtc84CdeWg data-mapping=pathname data-strict=1 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN crossorigin=anonymous async></script></main><footer>Made with <a href=https://github.com/janraasch/hugo-bearblog/>ʕ•ᴥ•ʔ</a></footer></body></html>