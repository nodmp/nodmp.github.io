<!doctype html><html lang=zh-cn><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://clientinfra.com/images/favicon.png><title>使用 VScode 阅读 Android Kernel 代码并调试 | Client Infra</title>
<meta name=title content="使用 VScode 阅读 Android Kernel 代码并调试"><meta name=description content="使用 VScode 阅读 Android Kernel 代码并调试,使用 GUI 增强用户开发体验"><meta name=keywords content="Kernel,VScode,AOSP,"><meta property="og:title" content="使用 VScode 阅读 Android Kernel 代码并调试"><meta property="og:description" content="使用 VScode 阅读 Android Kernel 代码并调试,使用 GUI 增强用户开发体验"><meta property="og:type" content="article"><meta property="og:url" content="https://clientinfra.com/read-android-kernel-source-code-with-vsccode/"><meta property="og:image" content="https://clientinfra.com/images/share.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2023-06-22T00:00:00+08:00"><meta property="article:modified_time" content="2023-06-22T00:00:00+08:00"><meta property="og:site_name" content="Client Infra"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://clientinfra.com/images/share.png"><meta name=twitter:title content="使用 VScode 阅读 Android Kernel 代码并调试"><meta name=twitter:description content="使用 VScode 阅读 Android Kernel 代码并调试,使用 GUI 增强用户开发体验"><meta itemprop=name content="使用 VScode 阅读 Android Kernel 代码并调试"><meta itemprop=description content="使用 VScode 阅读 Android Kernel 代码并调试,使用 GUI 增强用户开发体验"><meta itemprop=datePublished content="2023-06-22T00:00:00+08:00"><meta itemprop=dateModified content="2023-06-22T00:00:00+08:00"><meta itemprop=wordCount content="113"><meta itemprop=image content="https://clientinfra.com/images/share.png"><meta itemprop=keywords content="Kernel,VScode,AOSP,"><meta name=referrer content="no-referrer-when-downgrade"><style>body{font-family:roboto slab,pingfang sc,source han sans sc,source han sans cn,noto sans cjk sc,wenquanyi micro hei,microsoft yahei,sans-serif;margin:auto;padding:20px;max-width:720px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6{font-weight:600}h1,h2,h3,h4,h5,h6,strong,b{color:#222}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code,pre{font-family:fira mono,courier new,pingfang sc,source han sans sc,source han sans cn,noto sans cjk sc,wenquanyi micro hei,microsoft yahei,monospace!important}code{padding:.25em .5em;font-size:85%;color:#bf616a;background-color:#f9f9f9;border-radius:3px}pre{display:block;margin-top:0;margin-bottom:1rem;padding:1rem;font-size:.8rem;line-height:1.4;white-space:pre;white-space:pre-wrap;word-break:break-all;word-wrap:break-word;background-color:#f9f9f9;overflow-x:auto;tab-size:4;-moz-tab-size:4;padding:0}pre code{padding:0;font-size:100%;color:inherit;background-color:transparent}.highlight{margin-bottom:1rem;border-radius:4px}.highlight pre{margin-bottom:0}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:#8b6fcb}.nav{display:flex;align-items:baseline;flex-wrap:wrap;justify-content:space-between;margin-bottom:1rem}.nav-title{font-family:lora,sans-serif;font-size:1.5rem;color:#000;letter-spacing:-.055rem;font-weight:400;white-space:nowrap;text-decoration:none}.nav-links a{font-family:fira code,monospace;text-transform:lowercase;color:#b3b3b3;margin-right:2rem;font-weight:300;text-align:right;text-decoration:none}.nav-links a:last-of-type{margin-right:0}#TableOfContents{font-size:90%;margin-left:0!important;padding:.7em 1em;border-left:.25em solid rgba(9 9 9/.6);background-color:rgba(23 22 25/5%);margin:1em 0}#TableOfContents li{text-align:left}#TableOfContents ul{list-style:none;line-height:1.6;padding-left:1em;margin:0}#TableOfContents ul ul{margin-block-start:0;margin-block-end:0}@media(prefers-color-scheme:dark){body{background-color:#333;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#8cc2dd}code{background-color:#777;color:#fff}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}.helptext{color:#aaa}.nav-title{color:#ddd}pre{background-color:#333}#TableOfContents{background-color:rgba(0 0 0/.4)}}</style><link rel=stylesheet href="https://fonts.googlefonts.cn/css?family=Fira+Mono|Roboto+Slab:400,600|Noto+Serif+SC:600|Lora:700&display=swap"><script async src=https://umami.clientinfra.com/fd5c29bd-10f7-4017-80c8-9d7aaf7c3e8b data-website-id=b25f85f7-169d-4949-9ce5-1d9cea51b28c></script><link href=https://cdn.bootcdn.net/ajax/libs/highlight.js/11.8.0/styles/base16/dracula.min.css rel=stylesheet><script src=https://cdn.bootcdn.net/ajax/libs/highlight.js/11.8.0/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script></head><body><header><nav class=nav><a class=nav-title href=https://clientinfra.com/>Client Infra</a><div class=nav-links><a href=/blog>Posts</a></div></nav></header><main><h1>使用 VScode 阅读 Android Kernel 代码并调试</h1><p><i><time datetime=2023-06-22 pubdate>22 Jun, 2023</time></i></p><aside><nav id=TableOfContents><ul><li><a href=#前置知识>前置知识</a><ul><li><a href=#语言服务器协议language-server-protocollsp>语言服务器协议（Language Server Protocol/LSP）</a><ul><li><a href=#为什么要提出语言服务器协议并增加语言服务器呢>为什么要提出语言服务器协议并增加语言服务器呢？</a></li></ul></li><li><a href=#clangd>Clangd</a><ul><li><a href=#安装-clangd>安装 clangd</a></li><li><a href=#vscode安装clangd插件>VScode安装clangd插件</a></li><li><a href=#compile_commandsjson>compile_commands.json</a></li></ul></li></ul></li><li><a href=#vscode搭建源码阅读环境>VScode搭建源码阅读环境</a><ul><li><a href=#android-kernel生成compile_commandsjson>Android Kernel生成compile_commands.json</a></li><li><a href=#源码导入vscode>源码导入VScode</a></li><li><a href=#vscode调试内核>VSCode调试内核</a><ul><li><a href=#vscode调试插件安装>VScode调试插件安装</a></li><li><a href=#配置vscode-lunchjson调试配置文件>配置VSCode lunch.json调试配置文件</a></li><li><a href=#启动cuttlefish>启动Cuttlefish</a></li><li><a href=#vscode调试>VScode调试</a></li></ul></li></ul></li><li><a href=#总结>总结</a></li></ul></nav></aside><content><p>在上一篇文章中介绍了如何编译并调试内核，当读者想阅读代码或者修改代码时会发现，没有任何代码提示和跳转。当调试内核的时候又发现，gdb命令太多了十分不方便,让人不禁怀念有他———IDE的日子，那是多么惬意的时光。</p><h2 id=前置知识>前置知识</h2><h3 id=语言服务器协议language-server-protocollsp>语言服务器协议（Language Server Protocol/LSP）</h3><p>语言服务器协议（LSP）定义了编辑器或IDE与语言服务器之间使用的协议，语言服务器提供了自动完成、跳转定义、查找引用等语言功能。</p><h4 id=为什么要提出语言服务器协议并增加语言服务器呢>为什么要提出语言服务器协议并增加语言服务器呢？</h4><p>很久以前各IDE各自为营，例如Eclipse CDT（主要在Eclipse中提供C/C++支持）是由Java编写，如果一个使用TypeScript编写的IDE（例如：Visual Studio Code）想提供C/C++的支持就需要自己使用TypeScript重新写一套。</p><p>为了改善这样的局面，微软提出了LSP，将语言支持和编辑器之间增加一层抽象，编辑器/IDE只要实现LSP协议就拥有了复杂的语言支持功能，而对于语言服务器同样只需要关注实现LSP协议，而不限定使用何种语言。</p><p>关于更多语言服务器以及支持LSP的IDE列表，请查看<a href=https://microsoft.github.io/language-server-protocol/implementors/servers/>微软LSP官网</a></p><blockquote><p><strong>“Any problem in computer science can be solved by another layer of indirection.”</strong></p></blockquote><h3 id=clangd>Clangd</h3><p>Clangd是一个C++的语言服务器，他为C++语言提供了代码完成、编译错误、转到定义等功能。</p><p>下面是一个带有Clangd插件的Vs code,演示了代码完成功能：
<img src=https://img.clientinfra.com/client-infra-img/2024/02/86e0d243047bd910411eeb193e4c4b46.png alt></p><h4 id=安装-clangd>安装 clangd</h4><p>如果你本地有NDK环境,在NDK目录下已经有了clangd（/toolchains/llvm/prebuilt/linux-x86_64/bin/clangd）可以直接使用，如果想要独立安装，请查看<a href=https://clangd.llvm.org/installation#installing-clangd>文档</a></p><h4 id=vscode安装clangd插件>VScode安装clangd插件</h4><p>可以直接在VScode中选择<strong>View->Extensions</strong>打开插件管理，然后搜索"<strong>clangd</strong>&ldquo;单击安装</p><p>官方推荐<code>Make sure the Microsoft C/C++ extension is **not** installed</code>这里先忽略，在稍后配置文件中禁用。</p><p>安装后需要重载窗口，<strong>Ctrl+Shift+P</strong>并输入<strong>Reload Window</strong></p><h4 id=compile_commandsjson>compile_commands.json</h4><p>为了让clangd能够理解你的源代码，clangd需要知道你的构建标志，而这些信息通常由<a href=https://clang.llvm.org/docs/JSONCompilationDatabase.html>compile_commands.json</a>文件来记录，这个文件中记录了编译中每个源代码的编译命令，通常由编译系统自动生成。</p><ul><li>CMAKE通过传递CMAKE_EXPORT_COMPILE_COMMANDS=1来生成compile_commands.json</li><li>Bazel通过<a href=https://github.com/hedronvision/bazel-compile-commands-extractor>bazel-compile-commands-extractor</a>来生成compile_commands.json</li><li>对于make编译的项目，可以通过<a href=https://github.com/rizsotto/Bear>Bear</a>来生成compile_commands.json</li></ul><p>在拥有compile_commands.json文件后，可以通过<code>--compile-commands-dir</code>选项来指定数据库地址。</p><h2 id=vscode搭建源码阅读环境>VScode搭建源码阅读环境</h2><h3 id=android-kernel生成compile_commandsjson>Android Kernel生成compile_commands.json</h3><blockquote><p>本章的Android Kernel源码环境搭建参照上一篇文章</p></blockquote><p>经过前置知识的介绍，为了让clangd了解Android Kernel，需要生成一个compile_commands.json文件，上文中介绍了Android Kernel的构建系统为bazel，所以自然想到使用bazel-compile-commands-extractor来生成compile_commands.json文件，Android官方早就想到了开发者有这样的需求，所以早就预制了一个<a href=https://bazel.build/concepts/build-ref#targets>target</a> <code>kernel_compile_commands</code>并在build/kernel/kleaf/common_kernels.bzl中实现了该target。</p><p><img src=https://img.clientinfra.com/client-infra-img/2024/02/90e9082b3d9ece50f1af857848b99797.png alt>
<img src=https://img.clientinfra.com/client-infra-img/2024/02/2c228aa61b6e8d4e15e0c890dd596393.png alt></p><p>在Android Kernel根目录直接运行<code>tools/bazel run //common:kernel_x86_64_compile_commands</code>就会在根目录下生成compile_commands.json。</p><h3 id=源码导入vscode>源码导入VScode</h3><ol><li>直接使用VScode打开<strong>common</strong>目录，这时候只能简单的查看文件，并没有代码提示等功能</li><li><strong>Ctrl+Shift+P</strong>并输入<strong>Open Workspece Settings(JSON)</strong> 并选择，VScode会在根目录下生成<code>.vscode/settings.json</code>
<img src=https://img.clientinfra.com/client-infra-img/2024/02/e770092f67632f4fc2672d34a53f3edb.png alt></li><li>将下面代码复制到<code>.vscode/settings.json</code>,<strong>需要注意clangd.path的地址更换为读者本地路径</strong>
<script src=https://gist.github.com/nodmp/719195168947ce268ac5aa36157603c1.js></script></li><li>保存上面的settings.json，然后<strong>Ctrl+Shift+P</strong>并输入<strong>Reload Window</strong>,然后随便点击一个C文件，Clangd就会自动加载了，左下角会展示正在indexing，并在根目录下会生成.<code>cache</code>目录
<img src=https://img.clientinfra.com/client-infra-img/2024/02/565a86f5177e158f61377ccffa3909da.png alt></li><li>索引完成后，代码提示和符号跳转等功能就可以正常使用了。</li></ol><h3 id=vscode调试内核>VSCode调试内核</h3><p>VSCode代码调试基于<a href=https://juejin.cn/post/7244470938871808058#heading-11>上一篇文章-使用GDB调试Kernel</a>，在这里简单列一下步骤，详细信息请参照上一篇文章</p><h4 id=vscode调试插件安装>VScode调试插件安装</h4><p>安装<a href="https://marketplace.visualstudio.com/items?itemName=ms-vscode.cpptools-extension-pack">C/C++ Extension Pack</a>和<a href="https://marketplace.visualstudio.com/items?itemName=DamianKoper.gdb-debug">GDB Debug</a>两个插件</p><h4 id=配置vscode-lunchjson调试配置文件>配置VSCode lunch.json调试配置文件</h4><p><strong>Ctrl+Shift+D</strong>调出调试面板，点击<code>create a lunch.json file</code>选择<code>GDB Debug</code>目标，这时会在.vscode下生成一个lunch.json文件,将下面的代码全部替换
<script src=https://gist.github.com/nodmp/70988ac0676e0f490ff15df1ca8ab656.js></script>需要注意的是，由于Cuttlefish底层是由crosvm支持的，对内核的调试支持也是由crosvm中的gdb支持的，这里需要使用硬件断点才能正常Debug，所以使用<code>hardwareBreakpoints</code>将所有断点设置为硬件断点，否则将导致错误。</p><p>配置完成后，再次Reload Windows或者重启VScode</p><h4 id=启动cuttlefish>启动Cuttlefish</h4><pre tabindex=0><code>//切换到AOSP目录执行
source build/envsetup.sh
lunch aosp_cf_x86_64_phone-userdebug
launch_cvd -kernel_path /home/prosixe/ssd/Android/android-kernel/out/bzImage -initramfs_path /home/prosixe/ssd/Android/android-kernel/out/initramfs.img 
</code></pre><h4 id=vscode调试>VScode调试</h4><p>在你关心的地方设置断点，然后在VScode调试面板点击<code>Start Debugging(F5)</code>，之后代码就会停在断点处。</p><p><img src=https://img.clientinfra.com/client-infra-img/2024/02/f61d8a05b54c1c9bff30b2d6e8a2bc8b.png alt>
<img src=https://img.clientinfra.com/client-infra-img/2024/02/93b5c756462bb81e9834962ab17d00e7.png alt></p><h2 id=总结>总结</h2><p>配置调试环境的过程中并不是一帆风顺，在调试过程中就遇见VScode增加断点vm异常重启的问题，而gdb命令行就顺利运行，当搜索一大圈一无所获。只能阅读vscode-cpptools源码和GDB Remote Serial Protocol 文档，对比gdb命令行的协议数据。最后发现vscode的断点是break类型的，而crosvm需要hbread的断点才会正常，这和qemu虚拟机是有很大区别的，qemu无论是break还是hbreak都会正常suspend。</p><p>“工欲善其事，必先利其器”，功能丰富的IDE可以帮助我们节省许多时间，提高我们的学习体验。</p></content><p><a href=https://clientinfra.com/blog/kernel/>#Kernel</a>
<a href=https://clientinfra.com/blog/vscode/>#VScode</a>
<a href=https://clientinfra.com/blog/aosp/>#AOSP</a></p><script src=https://giscus.app/client.js data-repo=nodmp/nodmp.github.io data-repo-id=R_kgDOLXPtcw data-category=Announcements data-category-id=DIC_kwDOLXPtc84CdeWg data-mapping=pathname data-strict=1 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN crossorigin=anonymous async></script></main><footer>Made with <a href=https://github.com/janraasch/hugo-bearblog/>ʕ•ᴥ•ʔ</a></footer></body></html>