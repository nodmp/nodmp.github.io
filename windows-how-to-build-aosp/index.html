<!doctype html><html lang=zh-cn><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://clientinfra.com/images/favicon.png><title>写给 Windows 用户的 AOSP 构建开发环境配置指南 | Client Infra</title>
<meta name=title content="写给 Windows 用户的 AOSP 构建开发环境配置指南"><meta name=description content="Windows 用户如何使用 WSL2 编译 AOSP 并运行 Cuttlefish，不再需要虚拟机，媲美原生 Linux 的开发体验。"><meta name=keywords content="AOSP,WSL2,Cuttlefish,"><meta property="og:title" content="写给 Windows 用户的 AOSP 构建开发环境配置指南"><meta property="og:description" content="Windows 用户如何使用 WSL2 编译 AOSP 并运行 Cuttlefish，不再需要虚拟机，媲美原生 Linux 的开发体验。"><meta property="og:type" content="article"><meta property="og:url" content="https://clientinfra.com/windows-how-to-build-aosp/"><meta property="og:image" content="https://clientinfra.com/images/share.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2023-01-13T00:00:00+08:00"><meta property="article:modified_time" content="2023-01-13T00:00:00+08:00"><meta property="og:site_name" content="Client Infra"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://clientinfra.com/images/share.png"><meta name=twitter:title content="写给 Windows 用户的 AOSP 构建开发环境配置指南"><meta name=twitter:description content="Windows 用户如何使用 WSL2 编译 AOSP 并运行 Cuttlefish，不再需要虚拟机，媲美原生 Linux 的开发体验。"><meta itemprop=name content="写给 Windows 用户的 AOSP 构建开发环境配置指南"><meta itemprop=description content="Windows 用户如何使用 WSL2 编译 AOSP 并运行 Cuttlefish，不再需要虚拟机，媲美原生 Linux 的开发体验。"><meta itemprop=datePublished content="2023-01-13T00:00:00+08:00"><meta itemprop=dateModified content="2023-01-13T00:00:00+08:00"><meta itemprop=wordCount content="275"><meta itemprop=image content="https://clientinfra.com/images/share.png"><meta itemprop=keywords content="AOSP,WSL2,Cuttlefish,"><meta name=referrer content="no-referrer-when-downgrade"><style>body{font-family:roboto slab,pingfang sc,source han sans sc,source han sans cn,noto sans cjk sc,wenquanyi micro hei,microsoft yahei,sans-serif;margin:auto;padding:20px;max-width:720px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6{font-weight:600}h1,h2,h3,h4,h5,h6,strong,b{color:#222}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code,pre{font-family:fira mono,courier new,pingfang sc,source han sans sc,source han sans cn,noto sans cjk sc,wenquanyi micro hei,microsoft yahei,monospace!important}code{padding:.25em .5em;font-size:85%;color:#bf616a;background-color:#f9f9f9;border-radius:3px}pre{display:block;margin-top:0;margin-bottom:1rem;padding:1rem;font-size:.8rem;line-height:1.4;white-space:pre;white-space:pre-wrap;word-break:break-all;word-wrap:break-word;background-color:#f9f9f9;overflow-x:auto;tab-size:4;-moz-tab-size:4;padding:0}pre code{padding:0;font-size:100%;color:inherit;background-color:transparent}.highlight{margin-bottom:1rem;border-radius:4px}.highlight pre{margin-bottom:0}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:#8b6fcb}.nav{display:flex;align-items:baseline;flex-wrap:wrap;justify-content:space-between;margin-bottom:1rem}.nav-title{font-family:lora,sans-serif;font-size:1.5rem;color:#000;letter-spacing:-.055rem;font-weight:400;white-space:nowrap;text-decoration:none}.nav-links a{font-family:fira code,monospace;text-transform:lowercase;color:#b3b3b3;margin-right:2rem;font-weight:300;text-align:right;text-decoration:none}.nav-links a:last-of-type{margin-right:0}#TableOfContents{font-size:90%;margin-left:0!important;padding:.7em 1em;border-left:.25em solid rgba(9 9 9/.6);background-color:rgba(23 22 25/5%);margin:1em 0}#TableOfContents li{text-align:justify}#TableOfContents ul{list-style:none;line-height:1.6;padding-left:1em;margin:0}#TableOfContents ul ul{margin-block-start:0;margin-block-end:0}@media(prefers-color-scheme:dark){body{background-color:#333;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#8cc2dd}code{background-color:#777;color:#fff}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}.helptext{color:#aaa}.nav-title{color:#ddd}pre{background-color:#333}}</style><link rel=stylesheet href="https://fonts.googlefonts.cn/css?family=Fira+Mono|Roboto+Slab:400,600|Noto+Serif+SC:600|Lora:700&display=swap"><script async src=https://umami.clientinfra.com/fd5c29bd-10f7-4017-80c8-9d7aaf7c3e8b data-website-id=b25f85f7-169d-4949-9ce5-1d9cea51b28c></script><link href=https://cdn.bootcdn.net/ajax/libs/highlight.js/11.8.0/styles/base16/dracula.min.css rel=stylesheet><script src=https://cdn.bootcdn.net/ajax/libs/highlight.js/11.8.0/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script></head><body><header><nav class=nav><a class=nav-title href=https://clientinfra.com/>Client Infra</a><div class=nav-links><a href=/blog>Posts</a></div></nav></header><main><h1>写给 Windows 用户的 AOSP 构建开发环境配置指南</h1><p><i><time datetime=2023-01-13 pubdate>13 Jan, 2023</time></i></p><aside><nav id=TableOfContents><ul><li><a href=#wsl2环境安装-windows>WSL2环境安装 （Windows）</a><ul><li><a href=#修改wsl内存和cpu核心>修改WSL内存和CPU核心</a></li><li><a href=#修改软件源>修改软件源</a></li></ul></li><li><a href=#aosp编译环境搭建以及下载源码ubuntu>AOSP编译环境搭建以及下载源码（Ubuntu）</a><ul><li><a href=#配置环境>配置环境</a></li><li><a href=#配置账号>配置账号</a></li><li><a href=#下载源码>下载源码</a></li></ul></li><li><a href=#构建源码ubuntu>构建源码(Ubuntu)</a><ul><li><a href=#设置环境>设置环境</a></li><li><a href=#选择目标>选择目标</a></li><li><a href=#构建>构建</a></li></ul></li><li><a href=#运行>运行</a><ul><li><a href=#检查嵌套虚拟化ubuntu>检查嵌套虚拟化(Ubuntu)</a></li><li><a href=#构建wsl2内核以支持cuttlefishubuntu>构建WSL2内核以支持Cuttlefish（Ubuntu）</a></li><li><a href=#运行cuttlefish>运行Cuttlefish</a><ul><li><a href=#adb服务发现>ADB服务发现</a></li></ul></li></ul></li><li><a href=#总结>总结</a></li></ul></nav></aside><content><p>因为忍受不了Ubuntu在4K下的<code>Fractional Scaling</code>体验,最近将开发环境切换到了Windows11，并尝试在Windows11 + WSL2上搭建AOSP编译开发环境，并获得了以下体验</p><ul><li>成功编译AOSP</li><li>源码导入Source Insight</li><li>Cuttlefish成功运行编译镜像</li><li>源码导入宿主Android Studio并能够单步调试</li></ul><p>本文标题看起来仅将Windows系统包含在内，如果在Mac中找到WSL2的平等替代（例如：Docker），或者远程服务器替代WSL2的作用，那么本文也会受益于其他系统</p><blockquote><p>Windows11提供了嵌套虚拟化技术，如果是非Windows11不能成功运行Cuttlefish虚拟机，只能获得代码编译，阅读源码的体验，读者如果无需运行Cuttlefish或者拥有Pixel系列真机，则可以使用Windows10系统</p></blockquote><h2 id=wsl2环境安装-windows>WSL2环境安装 （Windows）</h2><p>*<em>CPU虚拟化是安装的前提环境，可以在任务管理器-性能-CPU查看是否显示虚拟化已启用</em></p><p>*<em>wsl默认会安装到C盘，如果C盘容量不够300G,则自行查阅资料将其迁移到其他符合条件的硬盘</em></p><p>初次使用WSL可以使用<code>wsl --install</code>直接初始化默认安装Ubuntu系统,如果已经安装过其他发行版本，可以使用<code>wsl --list --online</code> + <code>wsl --install -d &lt;DistroName></code>选择Ubuntu发行版进行安装,安装完成后按照提示配置账号密码进入系统，如有其他问题请参阅<a href=https://learn.microsoft.com/zh-cn/windows/wsl/install>官方文档</a></p><p><img src=https://img.clientinfra.com/client-infra-img/2024/02/3a3f6780b3606599a0bccca74e1b0184.png alt></p><h3 id=修改wsl内存和cpu核心>修改WSL内存和CPU核心</h3><p>默认情况下Windows给WSL的配置并不是很高，我们可以在C:/Users//目录下创建.wslconfig文件（注意无后缀名，window可能自己添加txt后缀，请注意区分）,</p><pre tabindex=0><code> [wsl2]
 processors=8
 memory=16GB
 nestedVirtualization=true
</code></pre><p>上述核心数和内存大小请按照本机实际情况编写，但是按照Google要求，内存至少为16G,修改成功后在Windwos命令行执行<code>wsl --shutdown</code>以生效，在重启后的Ubuntu命令行执行 <code>free -h</code>和 <code>cat /proc/cpuinfo| grep "processor"| wc -l</code>分别查看内存和cpu是否符合</p><h3 id=修改软件源>修改软件源</h3><p>配置软件源可以让你更快的下载编译所需的工具，在Ubuntu中使用下面的命令进行软件源的更换</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo sed -i <span class=s2>&#34;s@http://.*archive.ubuntu.com@https://mirrors.tuna.tsinghua.edu.cn@g&#34;</span> /etc/apt/sources.list
</span></span><span class=line><span class=cl>sudo sed -i <span class=s2>&#34;s@http://.*security.ubuntu.com@https://mirrors.tuna.tsinghua.edu.cn@g&#34;</span> /etc/apt/sources.list
</span></span></code></pre></div><p>然后运行 <code>sudo apt-get update</code> 更新索引以生效。</p><h2 id=aosp编译环境搭建以及下载源码ubuntu>AOSP编译环境搭建以及下载源码（Ubuntu）</h2><h3 id=配置环境>配置环境</h3><p>在Ubuntu中执行下述命令以配置搭建环境</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo apt-get install git-core gnupg flex bison build-essential zip curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 libncurses5 lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc unzip fontconfig
</span></span></code></pre></div><p>执行 <code>sudo apt-get install repo</code>来安装Repo工具</p><p>执行<code>sudo ln -s /usr/bin/python3 /usr/bin/python</code>将python链接到python3</p><h3 id=配置账号>配置账号</h3><p>使用下面的命令以配置环境，读者对google的贡献会以以下账号信息提交，Google要求Email信息必须是Google账号。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>git config --global user.name Your_Name
</span></span><span class=line><span class=cl>git config --global user.email you@gmail.com
</span></span></code></pre></div><h3 id=下载源码>下载源码</h3><p>因为网络限制，我们如果直接下载Android源码会遇见各种各样的网络问题，即便是我们有一个"通道"能够解决网络问题，但是由于Android源码太大，&ldquo;通道"流量不够等也会阻碍下载。所以我们要利用好国内的镜像服务，使用镜像下载全量的数据</p><p>我们选择使用Tuna镜像站下载AOSP Master源码，以下是详细步骤</p><ol><li>执行<code>export REPO_URL='https://mirrors.tuna.tsinghua.edu.cn/git/git-repo'</code>，因为repo工具在执行前会先去<code>https://gerrit.googlesource.com/git-repo</code>下载更新，由于网络限制，所以将其更换成Tuna镜像会提高下载速率</li><li>创建存储目录，目录名随意<code>mkdir aosp && cd aosp</code></li><li>初始化仓库<code>repo init -u https://mirrors.tuna.tsinghua.edu.cn/git/AOSP/platform/manifest</code><ol><li>上述仓库下载的是master分支，如果你想下载某一特定版本可以根据<a href=https://source.android.com/docs/setup/about/build-numbers#source-code-tags-and-builds>这份文档</a>传递<code>-b</code>参数指定分支,例如<code>repo init -u https://mirrors.tuna.tsinghua.edu.cn/git/AOSP/platform/manifest -b android-13.0.0_r23</code></li><li>！注意！选择陈旧tag可能不包含下文所述工具链，例如源码导入工具AIDEGen在Android10以上源码才可使用，Cuttlefish可能在旧版本中还未支持等，本文在Master分支测试通过</li></ol></li><li>执行<code>repo sync -j4</code>,-j4代表了并发数，超过4镜像站会出现503限制</li><li>拉取源码成功</li></ol><p>上述操作仅仅是将镜像站的代码拷贝了下来，如果想要给AOSP提交贡献，或者获取今天内的改动，那么镜像站就不那么即时了，如果有这方面的要求可以选择配置代理并设置官方源，这样就建立了和AOSP的交互环境</p><h2 id=构建源码ubuntu>构建源码(Ubuntu)</h2><p><em>以下命令全部在aosp根目录下运行</em></p><h3 id=设置环境>设置环境</h3><p>使用envsetup.sh脚本初始化环境：<code>source build/envsetup.sh</code></p><blockquote><p>该脚本为当前环境注入了工具，编译目录，编译产物等变量，关闭终端后会失效，之后介绍的所有命令都是执行<code>source build/envsetup.sh</code>命令之后，进入aosp目录之后，您应该始终执行一下该脚本</p></blockquote><h3 id=选择目标>选择目标</h3><p>执行<code>lunch</code>弹出菜单选择合适的类型</p><ul><li><p>如果您拥有Pixel系列手机，请遵循<a href=https://source.android.com/docs/setup/build/running#selecting-device-build>官方文档</a>选择类型，并需要下载私有驱动到aosp目录(！重要!)，请参阅<a href=https://source.android.com/docs/setup/download/downloading#obtaining-proprietary-binaries>文档</a></p></li><li><p>如果是跟随本教程运行虚拟机，请选择 <code>lunch aosp_cf_x86_64_phone-userdebug</code>类型，其中cf就代表Cuttlefish,说明本次构建的产物是专门给Cuttlefish来使用的</p></li></ul><h3 id=构建>构建</h3><p>执行<code>m</code>命令构建Android，并等待成功构建，这里会非常慢非常慢&mldr;</p><h2 id=运行>运行</h2><p><em>请确保您的电脑系统是Windwos11,如果<a href=https://learn.microsoft.com/zh-cn/virtualization/hyper-v-on-windows/user-guide/nested-virtualization>非Windows11</a>请忽略本章，并关注下一篇文章源码开发查看环境搭建相关</em></p><h3 id=检查嵌套虚拟化ubuntu>检查嵌套虚拟化(Ubuntu)</h3><p>1.请检查 nestedVirtualization=true 是否存在Windows<code>C:/Users/&lt;Username>/.wslconfig</code>文件中
2.在Ubuntu中使用<code>sudo apt install cpu-checker</code>并使用<code>kvm-ok</code>命令检查是否可用，如果不可用，可能WSL版本或者Windows版本不对。</p><h3 id=构建wsl2内核以支持cuttlefishubuntu>构建WSL2内核以支持Cuttlefish（Ubuntu）</h3><p>WSL2-Linux-Kernel是开源的，我们可以很简单的获取他，下面以<a href=https://github.com/microsoft/WSL2-Linux-Kernel/archive/refs/tags/linux-msft-wsl-5.15.83.1.tar.gz>linux-msft-wsl-5.15.83.1</a>为例，展示构建流程</p><ol><li><p>配置源码构建环境<code>sudo apt install build-essential flex bison dwarves libssl-dev libelf-dev bc</code></p></li><li><p>创建目录并下载源码<code> mkdir ~/kernel_wsl && cd ~/kernel_wsl && wget https://github.com/microsoft/WSL2-Linux-Kernel/archive/refs/tags/linux-msft-wsl-5.15.83.1.tar.gz</code>,其他版本请查看WSL2-Linux-Kernel Github Release</p></li><li><p>解压并将目录切换到源码目录<code>tar -xvf linux-msft-wsl-5.15.83.1.tar.gz</code> 并进入到解压后的目录<code>cd WSL2-Linux-Kernel-linux-msft-wsl-5.15.83.1/</code></p></li><li><p>使用微软的构建配置<code>cp Microsoft/config-wsl .config</code></p></li><li><p>执行<code>make menuconfig</code>微调参数</p><ol><li><p>修改Virtualization-> KVM for Intel/ KVM for AMD 两个全部点击M键将其编译成模块
<img src=https://img.clientinfra.com/client-infra-img/2024/02/6c741506c8ab6d45d83609ae523855d1.png alt></p></li><li><p>修改Processor type and features -> Linux guest support -> KVM Guest support 点击Y选中
<img src=https://img.clientinfra.com/client-infra-img/2024/02/d9091be98007e4df1be1be5891e8b40b.png alt></p></li><li><p>修改Device Drivers > VHOST drivers >vhost virtio-vsock driver 点击M将其编译成模块
<img src=https://img.clientinfra.com/client-infra-img/2024/02/448c91b4567110c54d1a8c967677fdf9.png alt></p></li><li><p>使用左右键移动到Save，按照提示保存并最后Exit</p></li></ol></li><li><p>执行<code>make -j8</code>编译内核</p></li><li><p>执行<code>sudo make modules_install</code>安装内核模块</p></li><li><p>将内核bzImage拷贝到C盘用户目录下和.wslconfig相同位置！别忘记修改！ <code>cp arch/x86/boot/bzImage /mnt/c/Users/&lt;username>/bzImage</code></p></li><li><p>在Windows中修改.wslconfig配置内核，最后.wslconfig如下所示,！别忘记修改！</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>[</span>wsl2<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>processors</span><span class=o>=</span><span class=m>8</span>
</span></span><span class=line><span class=cl><span class=nv>memory</span><span class=o>=</span>16GB
</span></span><span class=line><span class=cl><span class=nv>nestedVirtualization</span><span class=o>=</span><span class=nb>true</span>
</span></span><span class=line><span class=cl><span class=nv>kernel</span><span class=o>=</span>C:<span class=se>\\</span>Users<span class=se>\\</span>&lt;username&gt;<span class=se>\\</span>bzImage
</span></span></code></pre></div></li><li><p>在Windows命令行执行 <code>wsl --shutdown</code>并重启wsl</p></li><li><p>在Ubuntu中挂载内核模块<code>sudo modprobe kvm</code>和<code>sudo modprobe vhost_vsock</code>以及<code>sudo modprobe kvm_intel</code></p></li><li><p>再次检查<code>kvm-ok</code> 和 <code>lsmod</code>，会发现kvm不报错lsmod包含vhost_vsock和kvm即可</p></li></ol><h3 id=运行cuttlefish>运行Cuttlefish</h3><p>再次将目录切换到aosp目录下，执行<code>source build/envsetup.sh</code>以及<code>lunch aosp_cf_x86_64_phone-userdebug</code>,
然后执行<code>launch_cvd --start_webrtc=true</code>即可开启服务，查看日志在Windwos浏览器输入网址，即可操作Cuttlefish
<img src=https://img.clientinfra.com/client-infra-img/2024/02/f2d1e250e4d20c61571c5fb28bf2ab89.png alt></p><h4 id=adb服务发现>ADB服务发现</h4><p>因为Adb服务默认检测5555端口，而Cuttlefish开启的服务不一定是5555，
1.Ubuntu Shell执行<code>adb devices</code>获得port，然后将其转发到5555端口<code>adb forward tcp:5555 tcp:6520</code>，Windows端即可发现服务</p><p>2.Ubuntu Shell执行<code>adb devices</code>获得port, 然后在Windows端指定端口<code>adb connect localhost:6520</code></p><p><img src=https://img.clientinfra.com/client-infra-img/2024/02/6775e3d690efa479f0d59fdb3c467b7f.png alt></p><p><img src=https://img.clientinfra.com/client-infra-img/2024/02/17908771ebc45736a747c1c50da6daf3.png alt></p><p><img src=https://img.clientinfra.com/client-infra-img/2024/02/11ad4b63e164ad7107b620ec6a6b2013.png alt></p><h2 id=总结>总结</h2><p>至此，我们已经成功编译并运行了AOSP，借助Cuttlefish服务，我们使用宿主的浏览器即可操作虚拟机，并且可以使用adb连接服务。限于篇幅，下一篇文章将讲述如何使用AIDEGen将源码导入Windows端的Android Studio，因为<a href=https://github.com/microsoft/wslg>Wslg</a>的性能和体验并不能让我们满意，所以将Android Studio跑在WSL2并不是一个明智的选择，况且他的渲染并不好。</p></content><p><a href=https://clientinfra.com/blog/aosp/>#AOSP</a>
<a href=https://clientinfra.com/blog/wsl2/>#WSL2</a>
<a href=https://clientinfra.com/blog/cuttlefish/>#Cuttlefish</a></p><script src=https://giscus.app/client.js data-repo=nodmp/nodmp.github.io data-repo-id=R_kgDOLXPtcw data-category=Announcements data-category-id=DIC_kwDOLXPtc84CdeWg data-mapping=pathname data-strict=1 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN crossorigin=anonymous async></script></main><footer>Made with <a href=https://github.com/janraasch/hugo-bearblog/>ʕ•ᴥ•ʔ</a></footer></body></html>