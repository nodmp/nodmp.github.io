<!doctype html><html lang=zh-cn><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://clientinfra.com/images/favicon.png><title>使用 ASfP 搭建 Android Framwork 开发调试阅读环境 | Client Infra</title>
<meta name=title content="使用 ASfP 搭建 Android Framwork 开发调试阅读环境"><meta name=description content="使用 Android Studio for Platform 工具对 AOSP 代码进行构建和调试，增强 Framwork 开发人员的开发体验"><meta name=keywords content="Asfp,AOSP,Framwork,C++,"><meta property="og:title" content="使用 ASfP 搭建 Android Framwork 开发调试阅读环境"><meta property="og:description" content="使用 Android Studio for Platform 工具对 AOSP 代码进行构建和调试，增强 Framwork 开发人员的开发体验"><meta property="og:type" content="article"><meta property="og:url" content="https://clientinfra.com/asfp-android-framwork-debug/"><meta property="og:image" content="https://clientinfra.com/images/share.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2023-12-13T00:00:00+08:00"><meta property="article:modified_time" content="2023-12-13T00:00:00+08:00"><meta property="og:site_name" content="Client Infra"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://clientinfra.com/images/share.png"><meta name=twitter:title content="使用 ASfP 搭建 Android Framwork 开发调试阅读环境"><meta name=twitter:description content="使用 Android Studio for Platform 工具对 AOSP 代码进行构建和调试，增强 Framwork 开发人员的开发体验"><meta itemprop=name content="使用 ASfP 搭建 Android Framwork 开发调试阅读环境"><meta itemprop=description content="使用 Android Studio for Platform 工具对 AOSP 代码进行构建和调试，增强 Framwork 开发人员的开发体验"><meta itemprop=datePublished content="2023-12-13T00:00:00+08:00"><meta itemprop=dateModified content="2023-12-13T00:00:00+08:00"><meta itemprop=wordCount content="289"><meta itemprop=image content="https://clientinfra.com/images/share.png"><meta itemprop=keywords content="Asfp,AOSP,Framwork,C++,"><meta name=referrer content="no-referrer-when-downgrade"><style>body{font-family:roboto slab,pingfang sc,source han sans sc,source han sans cn,noto sans cjk sc,wenquanyi micro hei,microsoft yahei,sans-serif;margin:auto;padding:20px;max-width:720px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6{font-weight:600}h1,h2,h3,h4,h5,h6,strong,b{color:#222}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code,pre{font-family:fira mono,courier new,pingfang sc,source han sans sc,source han sans cn,noto sans cjk sc,wenquanyi micro hei,microsoft yahei,monospace!important}code{padding:.25em .5em;font-size:85%;color:#bf616a;background-color:#f9f9f9;border-radius:3px}pre{display:block;margin-top:0;margin-bottom:1rem;padding:1rem;font-size:.8rem;line-height:1.4;white-space:pre;white-space:pre-wrap;word-break:break-all;word-wrap:break-word;background-color:#f9f9f9;overflow-x:auto;tab-size:4;-moz-tab-size:4;padding:0}pre code{padding:0;font-size:100%;color:inherit;background-color:transparent}.highlight{margin-bottom:1rem;border-radius:4px}.highlight pre{margin-bottom:0}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:#8b6fcb}.nav{display:flex;align-items:baseline;flex-wrap:wrap;justify-content:space-between;margin-bottom:1rem}.nav-title{font-family:lora,sans-serif;font-size:1.5rem;color:#000;letter-spacing:-.055rem;font-weight:400;white-space:nowrap;text-decoration:none}.nav-links a{font-family:fira code,monospace;text-transform:lowercase;color:#b3b3b3;margin-right:2rem;font-weight:300;text-align:right;text-decoration:none}.nav-links a:last-of-type{margin-right:0}#TableOfContents{font-size:90%;margin-left:0!important;padding:.7em 1em;border-left:.25em solid rgba(9 9 9/.6);background-color:rgba(23 22 25/5%);margin:1em 0}#TableOfContents li{text-align:justify}#TableOfContents ul{list-style:none;line-height:1.6;padding-left:1em;margin:0}#TableOfContents ul ul{margin-block-start:0;margin-block-end:0}@media(prefers-color-scheme:dark){body{background-color:#333;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#8cc2dd}code{background-color:#777;color:#fff}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}.helptext{color:#aaa}.nav-title{color:#ddd}pre{background-color:#333}#TableOfContents{background-color:rgba(0 0 0/.4)}}</style><link rel=stylesheet href="https://fonts.googlefonts.cn/css?family=Fira+Mono|Roboto+Slab:400,600|Noto+Serif+SC:600|Lora:700&display=swap"><script async src=https://umami.clientinfra.com/fd5c29bd-10f7-4017-80c8-9d7aaf7c3e8b data-website-id=b25f85f7-169d-4949-9ce5-1d9cea51b28c></script><link href=https://cdn.bootcdn.net/ajax/libs/highlight.js/11.8.0/styles/base16/dracula.min.css rel=stylesheet><script src=https://cdn.bootcdn.net/ajax/libs/highlight.js/11.8.0/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script></head><body><header><nav class=nav><a class=nav-title href=https://clientinfra.com/>Client Infra</a><div class=nav-links><a href=/blog>Posts</a></div></nav></header><main><h1>使用 ASfP 搭建 Android Framwork 开发调试阅读环境</h1><p><i><time datetime=2023-12-13 pubdate>13 Dec, 2023</time></i></p><aside><nav id=TableOfContents><ul><li><a href=#构建-aosp-和运行-cuttlefish>构建 AOSP 和运行 Cuttlefish</a></li><li><a href=#asfp-的安装和导入>ASfP 的安装和导入</a><ul><li><a href=#安装-asfp>安装 ASfP</a></li><li><a href=#项目导入>项目导入</a></li></ul></li><li><a href=#调试>调试</a><ul><li><a href=#无可调试进程解决>无可调试进程解决</a></li><li><a href=#java-和-native-的调试>Java 和 Native 的调试</a></li></ul></li><li><a href=#最后>最后</a></li><li><a href=#参考>参考</a></li></ul></nav></aside><content><blockquote><p>在之前写<a href=https://juejin.cn/post/7188078567022919739>《写给Windows用户的AOSP构建开发环境配置指南》</a> 这篇文章的时候，留了一个坑——写一篇文章介绍如何使用Android Studio 对 AOSP Framework 进行调试。在填坑过程中发现 Android Studio 对 Native Framework 的调试支持不好，所以想着写一个 Intellij Plugins 来实现，然后再来补这篇文章，这其中又因为各种事耽搁了。恰巧前段时间 Android 推出了 <a href=https://developer.android.com/studio/platform>Android Studio for Platform</a> ，尝鲜后发现仅支持 Java Framwork 调试，直到最近看邮件组已经支持了 Native Framework 调试。</p></blockquote><p>ASfP(Android Studio for Platform) 是 Android 官方推出的专门为 AOSP 开发者打造的 Android Studio。ASfP 支持在一个 IDE 中进行 C++、Kotlin 和 Java 语言的编辑， 同时还支持将调试器附加到 Android 进程以调试 Java 和 C++ 代码，并集成了 Sonng 构建系统。</p><p>本篇文章将带领读者，使用 ASfP 搭建一个支持 AOSP 代码编辑和阅读，并能对 Native/Java Framwork 进行调试的环境。由于使用 Cuttlefish 虚拟机，读者可无需配备任何 Pixel 硬件，在个人电脑即可开始调试。</p><p>不论你是 Framework 工程师，还是想阅读代码的应用工程师，希望这篇文章能给你带来一点收获。</p><blockquote><p>ASfP 仅支持 Linux 环境，作者也是在 Linux 完成以下步骤，而非 WSL2 环境。</p></blockquote><h2 id=构建-aosp-和运行-cuttlefish>构建 AOSP 和运行 Cuttlefish</h2><p>在<a href=https://juejin.cn/post/7188078567022919739>《写给Windows用户的AOSP构建开发环境配置指南》</a> 中已经带领读者构建了 AOSP ,并运行了 Cuttlefish 虚拟机。虽然当时文章是在 WSL2 环境下进行构建，然而，只要留意带有 <strong>Ubuntu</strong> 标签的章节（注意：无需操作 <strong><a href=https://juejin.cn/post/7188078567022919739#heading-13>构建WSL2内核以支持Cuttlefish</a></strong> ），你就可以找到在 Ubuntu 上进行完整构建的清晰步骤，所以可以直接参考这篇文章进行构建，如有问题可以和作者沟通。</p><p>在跟随上文成功构建之后，之后我们再次启动 Cuttlefish 虚拟机可以按照下面的步骤进行。而不用每次都进行编译</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>source</span> build/envsetup.sh
</span></span><span class=line><span class=cl>lunch aosp_cf_x86_64_phone-userdebug
</span></span><span class=line><span class=cl>launch_cvd --start_webrtc<span class=o>=</span><span class=nb>true</span>
</span></span></code></pre></div><p>之后我们打开<code>https://localhost:8443/</code>就可以看到下面的页面了,我们将调试这台“云手机”进行开发调试，这样可以避免繁琐的刷机步骤和等待时间以及硬件的投入。</p><p><img src=https://img.clientinfra.com/client-infra-img/2024/02/a2dadcbb4019530791717bfadeb64386.png alt></p><h2 id=asfp-的安装和导入>ASfP 的安装和导入</h2><h3 id=安装-asfp>安装 ASfP</h3><ol><li>在<a href=https://developer.android.com/studio/platform>官网</a>下载 deb 包，当前最新版本为 <a href=https://dl.google.com/android/asfp/asfp-2023.2.1.19-linux.deb>asfp-2023.2.1.19</a></li><li>执行下面的命令进行安装 <code>sudo dpkg -i /path/to/asfp-2023.2.1.19-linux.deb</code></li><li>执行<code>/opt/android-studio-for-platform/bin/studio.sh</code>打开ASfP，之后你就能看到熟悉又带点陌生的 Android Studio 界面了
<img src=https://img.clientinfra.com/client-infra-img/2024/02/488e83ee41211a1fb4e9adfe036dcfef.png alt></li></ol><h3 id=项目导入>项目导入</h3><p>在成功安装 ASfP 之后，下面我们将 AOSP 源码导入到 ASfP 。</p><ol><li>点击<strong>Import Asfp Project</strong> 会出现下面的配置框:
<img src=https://img.clientinfra.com/client-infra-img/2024/02/78d48ff0c1cd4df7b9776e7de6e7a87c.png alt></li></ol><ul><li><strong>Repo checkout</strong> 是你 AOSP 下载的目录</li><li><strong>Lunch target</strong> 应该和构建 AOSP 时的目标一致，这里由于我们目标平台是 Cuttlefish 所以填写了<code>aosp_cf_x86_64_phone-userdebug</code>，如果你的目标是真机，按需修改。</li><li><strong>Module paths</strong> 选择你关心的目录，这里我们想要阅读调试 art 的代码,由于 art 为 Native 代码，所以勾选了<strong>Enable native（C/C++）support</strong> 选项</li><li>其他选项保持默认即可。然后点击 <strong>Finish</strong> 进行导入</li></ul><ol start=2><li><p>由于在之前我们已经进行过编译，所以在导入到 ASfP 过程中构建并不会花费很长时间（见到如下图中的绿色成功信息就是构建成功了），但是会花费大量的时间在 <strong>Indexing</strong> 上，这时候我们静静等待就好。
<img src=https://img.clientinfra.com/client-infra-img/2024/02/92ea05c9c2ee878f638274dab2be1cde.png alt>
<img src=https://img.clientinfra.com/client-infra-img/2024/02/98c77f04f957679d924bddc63b6a4392.png alt></p></li><li><p>在一切都完成后，这时候右上角 <strong>Attach Debugge</strong> 会变为可点击，Java/C++ 代码也会支持索引。</p></li></ol><h2 id=调试>调试</h2><h3 id=无可调试进程解决>无可调试进程解决</h3><p>当你点击了右上角 <strong>Attach Debugge</strong> 迫不及待的想调试一下 <strong>system_server</strong> 或者 <strong>Setting</strong> 的时候，你竟然发现？一个进程都没有？那肯定是我打开的姿势不对？
<img src=https://img.clientinfra.com/client-infra-img/2024/02/d1afccfbba8665e20f2d7d3be80a2ddb.png alt></p><p>这里是因为 Android 13 的这次<a href=https://android-review.googlesource.com/c/platform/frameworks/base/+/2217921/4/core/java/com/android/internal/os/Zygote.java#1009>修改</a>，由于我们是 userdebug 构建，只有 eng 构建才能够进行附加调试，那怎么办呢？很简单代码都在我们手上，我们改一下就好了。正好我们在 ASfP 里面编辑有代码提示，修改逻辑如下即可。</p><p><img src=https://img.clientinfra.com/client-infra-img/2024/02/42ad70b5aafc4a45eb01333d3d8bef32.png alt></p><blockquote><p>这里为什么选择直接修改代码，如果从 userdebug 改为 eng 构建需要花费较多的时间，<code>setprop persist.debug.dalvik.vm.jdwp.enabled 1</code>，又需要进程重启才能应用。</p></blockquote><p>在修改后，我们停止 Cuttlefish 虚拟机（Ctrl+Z 停止命令行），然后重新构建运行：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>source</span> build/envsetup.sh 
</span></span><span class=line><span class=cl>lunch aosp_cf_x86_64_phone-userdebug
</span></span><span class=line><span class=cl>m
</span></span><span class=line><span class=cl>launch_cvd --start_webrtc<span class=o>=</span><span class=nb>true</span>
</span></span></code></pre></div><p>这时候再次点击 <strong>Attach Debugge</strong> 发现，一切都回来了。</p><p><img src=https://img.clientinfra.com/client-infra-img/2024/02/a45f7d265ac5dcd4b4ca82f195ac797a.png alt></p><h3 id=java-和-native-的调试>Java 和 Native 的调试</h3><p>这里我们选择创建一个 Debugging App 来进行调试，别忘了 ASfP 就是 Android Studio，我们可以用 ASfP 新建一个 App ，这个 App 会在点击按钮之后调用 <code>Runtime.getRuntime().gc();</code>，然后将 App 安装到 Cuttlefish 虚拟机。
<img src=https://img.clientinfra.com/client-infra-img/2024/02/a478221a6d924c6400547ad3e95ec744.png alt></p><p>回到 AOSP 项目，attach 到 Debugging App 进程，并在 art/runtime/gc/heap.cc 文件中给<code>Heap::CollectGarbageInternal</code> 挂上断点，同时在 Runtime.java 给 <code>getRuntime</code> 挂上断点</p><p>点击测试应用的 Button 按钮，这时候会发现，首先触发了 Java 的断点，停在了<code>Runtime#getRuntime</code>，由于我们强制进行了 gc ，然后又会触发<code>Heap::CollectGarbageInternal</code> 断点，可见在 ASfP 中调试 AOSP 像我们调试应用一样简单方便。</p><p><img src=https://img.clientinfra.com/client-infra-img/2024/02/017ee2e8936a252f43583b57db0a7e4b.png alt>
<img src=https://img.clientinfra.com/client-infra-img/2024/02/5940ef1672ff57a6ef9ab81b49000dc1.png alt></p><h2 id=最后>最后</h2><p>ASfP 的推出不仅为 Framework 开发者带来了方便，对应用开发者来说，ASfP 能够让你无缝进行代码阅读的同时，还可以动手改一改，并动态的调一调，从之前在 Source insight “静态”的代码变成现在“动态”的代码，同时加深开发者对 Framework 的理解，增强自己的基本功。</p><p>AOSP 系列文章：</p><p><strong>环境搭建</strong>：<a href=https://juejin.cn/post/7188078567022919739>写给Windows用户的AOSP构建开发环境配置指南</a></p><p><strong>Android Kernel调试</strong>：<a href=https://juejin.cn/post/7244470938871808058> Android Kernel 编译与调试指北</a> & <a href=https://juejin.cn/post/7247167103874007077>使用VScode阅读Android Kernel代码并调试</a></p><h2 id=参考>参考</h2><p><a href=https://weishu.me/2017/01/14/how-to-debug-android-native-framework-source/>Weishu-如何调试Android Native Framework</a></p></content><p><a href=https://clientinfra.com/blog/asfp/>#Asfp</a>
<a href=https://clientinfra.com/blog/aosp/>#AOSP</a>
<a href=https://clientinfra.com/blog/framwork/>#Framwork</a>
<a href=https://clientinfra.com/blog/c/>#C++</a></p><script src=https://giscus.app/client.js data-repo=nodmp/nodmp.github.io data-repo-id=R_kgDOLXPtcw data-category=Announcements data-category-id=DIC_kwDOLXPtc84CdeWg data-mapping=pathname data-strict=1 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN crossorigin=anonymous async></script></main><footer>Made with <a href=https://github.com/janraasch/hugo-bearblog/>ʕ•ᴥ•ʔ</a></footer></body></html>